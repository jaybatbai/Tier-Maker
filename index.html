<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#09090b" id="meta-theme-color">
    <title>Tier List Pro - Enterprise Edition</title>
    
    <link rel="icon" href="./icon.png" type="image/png">
    
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://bernardo-castilho.github.io/DragDropTouch/DragDropTouch.js"></script>
    
    <style>
        /* THEME VARIABLES */
        :root[data-theme="dark"] { --bg-base: #09090b; --bg-surface: #18181b; --bg-elevated: #27272a; --border-color: #27272a; --border-hover: #3f3f46; --text-main: #f4f4f5; --text-muted: #a1a1aa; }
        :root[data-theme="light"] { --bg-base: #f4f4f5; --bg-surface: #ffffff; --bg-elevated: #e4e4e7; --border-color: #d4d4d8; --border-hover: #a1a1aa; --text-main: #09090b; --text-muted: #52525b; }
        :root { --primary: #10b981; --primary-hover: #059669; --accent: #3b82f6; --danger: #ef4444; --radius-lg: 16px; --radius-md: 12px; --radius-sm: 8px; --shadow-float: 0 20px 40px -10px rgba(0,0,0,0.3); transition: background-color 0.3s, color 0.3s; }

        /* GLOBAL */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--bg-elevated); border-radius: 10px; }
        body { background: var(--bg-base); color: var(--text-main); margin: 0; padding: 0; padding-bottom: 100px; overscroll-behavior: none; -webkit-font-smoothing: antialiased; }
        .hidden { display: none !important; }
        button:focus-visible, input:focus-visible, .list-item:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

        #app-container { width: 100%; max-width: 960px; margin: 0 auto; background: var(--bg-base); min-height: 100vh; border-left: 1px solid var(--border-color); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; position: relative; transition: all 0.3s; }
        
        /* OVERLAYS & TOASTS */
        #drop-overlay { position: fixed; inset: 0; background: rgba(16, 185, 129, 0.9); z-index: 10000; display: none; align-items: center; justify-content: center; color: white; font-size: clamp(1.2rem, 4vw, 2rem); font-weight: 700; backdrop-filter: blur(8px); border: 8px dashed rgba(255,255,255,0.5); pointer-events: none; text-align: center; padding: 20px;}
        #loading-overlay { z-index: 10002; flex-direction: column; color: white; font-weight: 600; font-size: 1.2rem; display: none; align-items: center; justify-content: center; position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(50px); background: var(--text-main); color: var(--bg-base); padding: 10px 24px; border-radius: 30px; font-weight: 600; opacity: 0; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); z-index: 10000; pointer-events: none; box-shadow: var(--shadow-float); white-space: nowrap; }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        #trash-zone { position: fixed; bottom: 100px; right: 30px; width: 70px; height: 70px; background: var(--danger); color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 1.8rem; z-index: 9999; box-shadow: 0 10px 25px rgba(239,68,68,0.5); border: 3px solid #fff; transition: transform 0.2s; }
        #trash-zone.hover { transform: scale(1.2); background: #dc2626; }

        /* MENU SCREEN */
        #menu-screen { padding: 60px 20px; flex: 1; display: flex; flex-direction: column; align-items: center; }
        .app-header { display: flex; align-items: center; justify-content: space-between; width: 100%; max-width: 380px; margin-bottom: 30px; }
        .app-title { color: var(--text-main); font-size: clamp(2rem, 6vw, 2.5rem); margin: 0; font-weight: 800; letter-spacing: -1px; text-transform: uppercase; }
        .app-title span { color: var(--primary); }
        .theme-toggle { background: transparent; border: 1px solid var(--border-color); color: var(--text-main); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: 0.2s; }
        
        /* AUTH UI */
        .auth-container { display: flex; flex-direction: column; gap: 10px; width: 100%; max-width: 380px; margin-bottom: 25px; align-items: center; }
        .user-badge { display: flex; align-items: center; gap: 10px; background: var(--bg-elevated); padding: 8px 16px; border-radius: 30px; border: 1px solid var(--border-color); font-weight: 600; font-size: 0.9rem; }
        .user-avatar { width: 24px; height: 24px; border-radius: 50%; }
        .btn-logout { background: transparent; color: var(--danger); border: none; font-weight: bold; cursor: pointer; padding: 5px 10px; }
        .btn-login-google { width: 100%; padding: 14px; background: white; color: black; border: 1px solid #ccc; border-radius: var(--radius-md); font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; }
        .btn-login-google:hover { background: #f1f1f1; }

        .menu-actions { display: flex; flex-direction: column; gap: 12px; width: 100%; max-width: 380px; margin-bottom: 50px; }
        .btn-create { width: 100%; padding: 16px; background: var(--primary); color: #fff; font-weight: 600; border: none; border-radius: var(--radius-md); font-size: 1.05rem; cursor: pointer; transition: all 0.2s; }
        .btn-data { width: 100%; padding: 14px; background: var(--bg-surface); color: var(--text-main); border: 1px solid var(--border-color); border-radius: var(--radius-md); font-weight: 500; cursor: pointer; transition: 0.2s; font-size: 0.95rem; }
        
        #list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; width: 100%; }
        @keyframes cardEnter { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .list-item { background: var(--bg-surface); border-radius: var(--radius-lg); overflow: hidden; border: 1px solid var(--border-color); cursor: pointer; transition: transform 0.1s ease, box-shadow 0.2s; display: flex; flex-direction: column; position: relative; opacity: 0; animation: cardEnter 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .list-item:hover { box-shadow: var(--shadow-float); }
        .btn-delete-list { position: absolute; top: 10px; right: 10px; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 8px; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; transition: 0.2s; backdrop-filter: blur(4px); z-index: 10; }
        .list-info-wrap { padding: 15px; display: flex; align-items: center; }

        /* EDITOR SCREEN & REST OF CSS */
        .top-bar { background: var(--bg-surface); opacity: 0.95; backdrop-filter: blur(12px); padding: 12px 20px; display: flex; gap: 10px; align-items: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; }
        .btn-back { background: transparent; color: var(--text-main); border: none; cursor: pointer; font-weight: bold; font-size: 1.1rem; padding: 5px; }
        .list-name-input { flex: 1; min-width: 120px; background: transparent; border: none; color: var(--text-main); font-size: 1.1rem; font-weight: 600; outline: none; text-overflow: ellipsis; }
        .top-actions { display: flex; gap: 6px; flex-wrap: nowrap; }
        .btn-icon { background: var(--bg-elevated); color: var(--text-main); border: 1px solid var(--border-color); padding: 6px 10px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .capture-wrapper { padding: 10px; background: var(--bg-base); overflow-x: auto; } 
        #capture-area { background: #000; display: inline-flex; flex-direction: column; min-width: 100%; border-radius: 0; border: none; }
        .board-header-style { text-align: center; font-size: clamp(1.2rem, 4vw, 1.75rem); font-weight: 800; padding: 25px 15px; background: #000; color: #fff; text-transform: uppercase; border-bottom: 1px solid #000; cursor: pointer; transition: background 0.2s; }
        #tier-board { display: flex; flex-direction: column; gap: 0; background: #000; border-top: 1px solid #000; } 
        .tier-row { display: flex; align-items: stretch; background: #1a1a1a; border-bottom: 1px solid #000; transition: border-top 0.2s; touch-action: none; }
        .tier-label-wrap { width: 100px; min-width: 100px; display: flex; align-items: center; justify-content: center; border-right: 1px solid #000; }
        @media (min-width: 600px) { .tier-label-wrap { width: 120px; min-width: 120px; } } 
        .tier-label { font-family: Arial, Helvetica, sans-serif; font-size: 14px; font-weight: 400; line-height: 1.3; color: #000; text-align: center; padding: 8px; word-wrap: break-word; overflow-wrap: break-word; cursor: pointer; width: 100%; position: relative; }
        .tier-content { flex: 1; display: flex; flex-wrap: wrap; align-content: center; align-items: center; background: #1a1a1a; padding: 0px; gap: 0px; position: relative; min-height: 85px; transition: background 0.2s; }
        
        .img-wrap { display: block; position: relative; cursor: pointer; transition: transform 0.15s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.2s; margin: 0; padding: 0; touch-action: none; }
        .img-wrap.selected { outline: 3px solid var(--accent); outline-offset: -3px; z-index: 5; box-shadow: 0 4px 15px rgba(0,0,0,0.5); transform: scale(0.98); }
        .img-wrap.dragging { opacity: 0.2; transform: scale(0.85); }
        .drag-placeholder { opacity: 0.7; outline: 3px dashed var(--primary); outline-offset: -3px; pointer-events: none !important; transform: scale(0.98); animation: fadeInGhost 0.2s; border-radius: 4px; overflow: hidden; filter: brightness(1.2); }
        @keyframes fadeInGhost { from { opacity: 0; transform: scale(0.8); } to { opacity: 0.7; transform: scale(0.98); } }
        .img-item { height: 85px; width: auto; border-radius: 0; display: block; pointer-events: none; }
        .img-caption { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.7); color: white; font-size: 11px; text-align: center; padding: 2px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; pointer-events: none; }
        .dock-container { background: var(--bg-base); padding: 15px; flex: 1; border-top: 1px solid var(--border-color); }
        #dock::-webkit-scrollbar { width: 6px; height: 6px; }
        #dock::-webkit-scrollbar-track { background: transparent; }
        #dock::-webkit-scrollbar-thumb { background: var(--border-hover); border-radius: 10px; }
        #dock { display: flex; flex-wrap: wrap; gap: 6px; padding: 10px; background: var(--bg-surface); min-height: 100px; max-height: 35vh; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--radius-sm); box-shadow: inset 0 2px 10px rgba(0,0,0,0.1); }
        .bottom-toolbar { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 960px; background: var(--bg-surface); opacity: 0.95; backdrop-filter: blur(16px); padding: 12px 20px; padding-bottom: max(12px, env(safe-area-inset-bottom)); display: flex; gap: 12px; border-top: 1px solid var(--border-color); z-index: 200; flex-wrap: wrap; }
        .btn-bottom { flex: 1; min-width: 140px; padding: 14px; border: none; border-radius: var(--radius-md); font-size: 0.95rem; font-weight: 600; cursor: pointer; text-align: center; transition: transform 0.1s; color: var(--text-main); }
        .btn-save { background: var(--bg-elevated); border: 1px solid var(--border-color); } 
        .btn-add { background: var(--text-main); color: var(--bg-base); } 
        #resize-control { position: fixed; bottom: calc(80px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); width: 90%; max-width: 420px; background: var(--bg-surface); opacity: 0.98; backdrop-filter: blur(20px); border: 1px solid var(--border-color); border-radius: var(--radius-lg); z-index: 250; padding: 20px; display: flex; flex-direction: column; gap: 16px; box-shadow: var(--shadow-float); }
        .size-slider-wrap { display: flex; align-items: center; gap: 10px; }
        .btn-size-step { background: var(--bg-elevated); color: var(--text-main); border: 1px solid var(--border-color); width: 34px; height: 34px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
        .resize-slider { flex: 1; height: 4px; background: var(--border-color); outline: none; -webkit-appearance: none; }
        .control-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-pill { padding: 12px 5px; border-radius: var(--radius-md); border: none; font-weight: 600; font-size: 0.85rem; cursor: pointer; background: var(--bg-elevated); color: var(--text-main); border: 1px solid var(--border-color); }
        @media (min-width: 768px) { .board-header-style { font-size: 2rem; padding: 30px; } .tier-label-wrap { width: 140px; min-width: 140px; } .tier-label { font-size: 16px; } .bottom-toolbar { padding: 15px 40px; gap: 20px; } .btn-bottom { font-size: 1.05rem; } #dock { max-height: 40vh; gap: 8px; padding: 15px; } }
        @keyframes overlayFadeIn { from { opacity: 0; backdrop-filter: blur(0px); } to { opacity: 1; backdrop-filter: blur(8px); } }
        @keyframes modalPopUp { 0% { opacity: 0; transform: scale(0.9) translateY(20px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 300; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); padding: 20px; animation: overlayFadeIn 0.2s ease-out forwards; }
        .modal { background: var(--bg-surface); padding: 28px; border-radius: var(--radius-lg); width: 100%; max-width: 400px; border: 1px solid var(--border-color); box-shadow: var(--shadow-float); animation: modalPopUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .modal h2 { margin-top: 0; color: var(--text-main); }
        .modal input[type="text"], .modal textarea { width: 100%; padding: 14px; background: var(--bg-base); color: var(--text-main); border: 1px solid var(--border-color); border-radius: var(--radius-md); outline: none; font-family: inherit; }
        .modal-btns { display: flex; flex-direction: column; gap: 10px; margin-top: 28px; }
        .modal-btns button { width: 100%; padding: 14px; border-radius: var(--radius-md); font-weight: 600; cursor: pointer; border: none; font-size: 1rem; }
        .tier-controls-btn { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-elevated); color: var(--text-main); cursor: pointer; font-weight: bold; font-size: 0.9rem; }
        .color-preset-btn { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid rgba(0,0,0,0.5); transition: transform 0.1s; }
        .color-preset-btn:hover { transform: scale(1.1); }
        .shortcut-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); color: var(--text-main); font-size: 0.9rem;}
        kbd { background: var(--bg-elevated); border: 1px solid var(--border-color); padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 0.85rem; color: var(--text-main); }
        body.zen-mode .top-bar, body.zen-mode .board-footer-actions, body.zen-mode .dock-container, body.zen-mode .bottom-toolbar, body.zen-mode #resize-control { display: none !important; }
        #exit-zen-btn { display: none; position: fixed; top: 20px; right: 20px; z-index: 10000; padding: 12px 24px; background: rgba(0,0,0,0.5); color: white; border-radius: 9999px; border: 1px solid white; cursor: pointer; backdrop-filter: blur(4px); }
    </style>
</head>
<body>
    <div id="drop-overlay">K√©o th·∫£ ·∫£nh v√†o ƒë√¢y ƒë·ªÉ th√™m</div>
    <button id="exit-zen-btn" onclick="toggleZenMode()">Tho√°t Zen Mode (ESC)</button>
    <div id="trash-zone" aria-label="Khu v·ª±c x√≥a ·∫£nh">üóëÔ∏è</div>
    <div id="toast" role="alert">üíæ ƒê√£ l∆∞u t·ª± ƒë·ªông</div>
    
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-text" style="margin-top: 20px;">ƒêang x·ª≠ l√Ω...</p>
    </div>

    <div id="app-container">
        <div id="menu-screen">
            <div class="app-header">
                <h1 class="app-title">Tier<span>Maker</span></h1>
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="Chuy·ªÉn ƒë·ªïi giao di·ªán S√°ng/T·ªëi" title="S√°ng/T·ªëi">üåô</button>
            </div>
            
            <div class="auth-container">
                <div id="user-profile" class="user-badge" style="display: none;">
                    <img id="user-avatar" class="user-avatar" src="" alt="Avatar">
                    <span id="user-name">ƒêang t·∫£i...</span>
                    <button class="btn-logout" onclick="logoutFromCloud()">ƒêƒÉng xu·∫•t</button>
                </div>
                <button id="btn-login" class="btn-login-google" onclick="loginWithGoogle()">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="width:18px">
                    ƒêƒÉng nh·∫≠p ƒë·ªÉ L∆∞u tr√™n Cloud
                </button>
            </div>

            <div class="menu-actions">
                <button class="btn-create" onclick="openCreateModal()">+ T·∫°o Template M·ªõi</button>
                <button class="btn-data" onclick="openBackupMenu()">üì¶ Nh·∫≠p / Xu·∫•t d·ªØ li·ªáu</button>
            </div>
            <div id="list-container" role="list">ƒêang t·∫£i d·ªØ li·ªáu...</div>
        </div>
        
        <div id="editor-screen" class="hidden">
            <div class="top-bar">
                <button class="btn-back" onclick="backToMenu()" aria-label="Quay l·∫°i">‚Äπ Tho√°t</button>
                <input type="text" id="list-name" class="list-name-input" oninput="debounceSaveName()" aria-label="T√™n b·∫£ng">
                <div class="top-actions">
                    <button class="btn-icon" onclick="openHelpModal()" aria-label="Ph√≠m t·∫Øt" title="Ph√≠m t·∫Øt">‚å®Ô∏è</button>
                    <button class="btn-icon" onclick="undo()" aria-label="Ho√†n t√°c" title="Ho√†n t√°c (Ctrl+Z)">‚Ü©Ô∏è</button>
                    <button class="btn-icon" onclick="redo()" aria-label="L√†m l·∫°i" title="L√†m l·∫°i (Ctrl+Y)">‚Ü™Ô∏è</button>
                    <button class="btn-icon" onclick="toggleZenMode()" aria-label="To√†n m√†n h√¨nh" title="To√†n m√†n h√¨nh">üëÅÔ∏è</button>
                </div>
            </div>
            
            <div class="capture-wrapper">
                <div id="capture-area">
                    <div id="tier-header" class="board-header-style" title="ƒê·ªïi t√™n b·∫£ng" onclick="openHeaderModal()">B·∫£ng X·∫øp H·∫°ng</div>
                    <div id="tier-board"></div>
                </div>
            </div>
            
            <div class="board-footer-actions" style="padding: 0 20px 20px 20px; display:flex; flex-wrap: wrap; gap:10px;">
                <button onclick="addNewTier()" class="btn-icon" style="flex:1;">+ Th√™m H√†ng</button>
                <button onclick="toggleHeader()" class="btn-icon" style="flex:1;">Ti√™u ƒë·ªÅ B·∫≠t/T·∫Øt</button>
                <button onclick="resetBoard()" class="btn-icon" style="color:var(--danger); border-color:var(--danger); flex:1;">Reset B·∫£ng</button>
            </div>
            
            <div id="dock-container-box" class="dock-container">
                <div id="dock" aria-label="Kho ·∫£nh"></div>
            </div>
            
            <div class="bottom-toolbar">
                <button class="btn-bottom btn-save" onclick="saveImage()">L∆∞u ·∫¢nh (4K)</button>
                <button class="btn-bottom btn-add" onclick="document.getElementById('imgInput').click()">Th√™m ·∫¢nh</button>
            </div>
            
            <input type="file" id="imgInput" multiple accept="image/*" onchange="handleFiles(event)" style="display:none">
        </div>

        <div id="resize-control" class="hidden">
            <div class="size-slider-wrap">
                <button class="btn-size-step" aria-label="Gi·∫£m k√≠ch th∆∞·ªõc" onclick="adjustSize(-5); markDirty();">-</button>
                <input type="range" id="size-slider" min="40" max="300" value="85" oninput="resizeSelectedImg(this.value)" onchange="markDirty()" class="resize-slider" aria-label="Thanh tr∆∞·ª£t k√≠ch th∆∞·ªõc">
                <button class="btn-size-step" aria-label="TƒÉng k√≠ch th∆∞·ªõc" onclick="adjustSize(5); markDirty();">+</button>
                <span id="size-val" style="min-width:45px; text-align:right; color:var(--text-main);">85px</span>
            </div>
            <div class="control-actions">
                <button class="btn-pill" onclick="moveToDock()">‚Üì C·∫•t Kho</button>
                <button class="btn-pill" onclick="openCaptionModal()">‚úçÔ∏è Ch·ªØ</button>
                <button class="btn-pill" onclick="applyToAll()" style="background:var(--text-main); color:var(--bg-base);">‚ú¶ C√πng c·ª°</button>
                <button class="btn-pill" onclick="deleteSelected()" style="background:var(--danger); color:white; border:none;">‚úï X√≥a (Del)</button>
            </div>
            <button onclick="deselectImg()" style="width:100%; margin-top:10px; background:transparent; border:1px solid var(--border-color); color:var(--text-main); padding:10px; border-radius:8px; cursor:pointer;">Xong (Esc)</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay"><div class="modal"><h2 id="confirm-title">X√°c nh·∫≠n</h2><p id="confirm-desc" style="color:var(--text-muted); margin-bottom: 20px;">B·∫°n c√≥ ch·∫Øc ch·∫Øn?</p><div class="modal-btns" style="flex-direction: row;"><button style="background:transparent; color:var(--text-main); border: 1px solid var(--border-color);" onclick="execCancel()">H·ªßy</button><button style="background:var(--danger); color:white;" onclick="execConfirm()">ƒê·ªìng √Ω</button></div></div></div>
    <div id="create-modal-overlay" class="modal-overlay"><div class="modal"><h2>T·∫°o b·∫£ng m·ªõi</h2><input type="text" id="new-template-name" placeholder="Nh·∫≠p t√™n b·∫£ng..." onkeypress="if(event.key==='Enter') confirmCreateList()"><div class="modal-btns"><button class="btn-add" style="background:var(--text-main); color:var(--bg-base);" onclick="confirmCreateList()">T·∫°o ngay</button><button onclick="closeModal('create-modal-overlay')" style="background:transparent; color:var(--text-main);">H·ªßy</button></div></div></div>
    <div id="modal-overlay" class="modal-overlay"><div class="modal"><h2>Ch·ªânh s·ª≠a H√†ng</h2><input type="text" id="edit-name" onkeypress="if(event.key==='Enter') saveTierEdit()"><div style="margin-top:20px;"><label style="display:block; margin-bottom:8px; font-weight:bold; color:var(--text-main);">M√†u n·ªÅn:</label><div style="display:flex; align-items:center; gap:10px;"><input type="color" id="edit-color-picker" style="cursor:pointer; width: 40px; height: 35px; border:none; background:transparent;" aria-label="B·ªô ch·ªçn m√†u"><div style="display:flex; flex-wrap:wrap; gap:6px; max-width: 280px;"><div class="color-preset-btn" style="background:#FF7F7F;" onclick="setTierColor('#FF7F7F')"></div><div class="color-preset-btn" style="background:#FFBF7F;" onclick="setTierColor('#FFBF7F')"></div><div class="color-preset-btn" style="background:#FFDF7F;" onclick="setTierColor('#FFDF7F')"></div><div class="color-preset-btn" style="background:#FFFF7F;" onclick="setTierColor('#FFFF7F')"></div><div class="color-preset-btn" style="background:#BFFF7F;" onclick="setTierColor('#BFFF7F')"></div><div class="color-preset-btn" style="background:#7FFF7F;" onclick="setTierColor('#7FFF7F')"></div><div class="color-preset-btn" style="background:#7FFFFF;" onclick="setTierColor('#7FFFFF')"></div><div class="color-preset-btn" style="background:#7FBFFF;" onclick="setTierColor('#7FBFFF')"></div><div class="color-preset-btn" style="background:#7F7FFF;" onclick="setTierColor('#7F7FFF')"></div><div class="color-preset-btn" style="background:#FF7FFF;" onclick="setTierColor('#FF7FFF')"></div><div class="color-preset-btn" style="background:#BF7FFF;" onclick="setTierColor('#BF7FFF')"></div><div class="color-preset-btn" style="background:#333333;" onclick="setTierColor('#333333')"></div><div class="color-preset-btn" style="background:#888888;" onclick="setTierColor('#888888')"></div><div class="color-preset-btn" style="background:#CCCCCC;" onclick="setTierColor('#CCCCCC')"></div><div class="color-preset-btn" style="background:#FFFFFF;" onclick="setTierColor('#FFFFFF')"></div></div></div></div><div style="margin-top:25px; display:flex; gap:10px;"><button class="tier-controls-btn" onclick="moveTierUp()">üîº ƒê·∫©y l√™n</button><button class="tier-controls-btn" onclick="moveTierDown()">üîΩ ƒê·∫©y xu·ªëng</button></div><div class="modal-btns"><button style="background:var(--text-main); color:var(--bg-base);" onclick="saveTierEdit()">L∆∞u thay ƒë·ªïi</button><button style="background:var(--danger); color:#fff; border:none;" onclick="deleteTier()">X√≥a H√†ng</button><button style="background:transparent; color:var(--text-main); border: 1px solid var(--border-color);" onclick="closeModal('modal-overlay')">ƒê√≥ng</button></div></div></div>
    <div id="caption-modal-overlay" class="modal-overlay"><div class="modal"><h2>Ch√∫ th√≠ch ·∫£nh</h2><input type="text" id="caption-input" placeholder="T√™n nh√¢n v·∫≠t..." onkeypress="if(event.key==='Enter') saveCaption()"><div class="modal-btns"><button style="background:var(--text-main); color:var(--bg-base);" onclick="saveCaption()">L∆∞u</button><button style="background:transparent; color:var(--text-main);" onclick="closeModal('caption-modal-overlay')">H·ªßy</button></div></div></div>
    <div id="help-modal" class="modal-overlay"><div class="modal"><h2>Ph√≠m t·∫Øt h·ªá th·ªëng</h2><div style="margin-top: 15px;"><div class="shortcut-row"><span>L∆∞u b·∫£ng th·ªß c√¥ng</span> <kbd>Ctrl + S</kbd></div><div class="shortcut-row"><span>Ho√†n t√°c (Undo)</span> <kbd>Ctrl + Z</kbd></div><div class="shortcut-row"><span>L√†m l·∫°i (Redo)</span> <kbd>Ctrl + Y</kbd></div><div class="shortcut-row"><span>X√≥a ·∫£nh ƒëang ch·ªçn</span> <kbd>Del / Back</kbd></div><div class="shortcut-row"><span>B·ªè ch·ªçn / Tho√°t</span> <kbd>Esc</kbd></div></div><div class="modal-btns"><button style="background:var(--primary); color:#fff;" onclick="closeModal('help-modal')">ƒê√£ hi·ªÉu</button></div></div></div>
    <div id="backup-modal-overlay" class="modal-overlay"><div class="modal"><h2>D·ªØ li·ªáu & Sao l∆∞u</h2><p style="color:var(--text-muted); font-size:0.9rem; margin-bottom: 20px;">L∆∞u √Ω: N·∫øu b·∫°n ƒëang ƒëƒÉng nh·∫≠p, d√°n/nh·∫≠p d·ªØ li·ªáu s·∫Ω t·ª± ƒë·ªông ƒë·ªìng b·ªô l√™n Cloud lu√¥n.</p><div class="modal-btns"><button style="background:var(--primary); color:#fff;" onclick="exportData()">‚¨áÔ∏è Xu·∫•t d·ªØ li·ªáu (T·∫£i file)</button><button style="background:var(--accent); color:#fff;" onclick="document.getElementById('importInput').click()">‚¨ÜÔ∏è Nh·∫≠p d·ªØ li·ªáu (Kh√¥i ph·ª•c)</button><button style="background:#f59e0b; color:#fff; margin-top:10px;" onclick="copyDataToClipboard()">üìã Copy Code (D√°n m√°y kh√°c)</button><button style="background:#8b5cf6; color:#fff; margin-top:5px;" onclick="pasteDataFromClipboard()">üìù D√°n Code (L·∫•y t·ª´ m√°y kh√°c)</button><button style="background:var(--danger); color:#fff; margin-top:15px;" onclick="wipeAllData()">üóëÔ∏è X√≥a s·∫°ch m·ªçi th·ª© (Reset Local)</button><button style="background:transparent; color:var(--text-main); margin-top:5px;" onclick="closeModal('backup-modal-overlay')">ƒê√≥ng</button></div><input type="file" id="importInput" accept=".json" onchange="importData(event)" style="display:none" aria-label="Nh·∫≠p file d·ªØ li·ªáu"></div></div>
    <div id="manual-paste-modal" class="modal-overlay"><div class="modal"><h2>D√°n m√£ d·ªØ li·ªáu</h2><p style="color:var(--text-muted); font-size:0.85rem;">Tr√¨nh duy·ªát ch·∫∑n d√°n t·ª± ƒë·ªông. Nh·∫•n v√†o √¥ b√™n d∆∞·ªõi v√† b·∫•m <kbd>Ctrl+V</kbd>.</p><textarea id="manual-paste-textarea" rows="4" placeholder="D√°n m√£ v√†o ƒë√¢y..."></textarea><div class="modal-btns"><button style="background:#8b5cf6; color:#fff;" onclick="processManualPaste()">Kh√¥i ph·ª•c d·ªØ li·ªáu</button><button style="background:transparent; color:var(--text-main);" onclick="closeModal('manual-paste-modal')">H·ªßy</button></div></div></div>

    <script>
        // ----------------------------------------------------
        // 0. FIREBASE SETUP & AUTHENTICATION
        // ----------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyBz9frJnJYOiJlrZifzLAwZEnm8EyCkrr8",
            authDomain: "tierlistpro-46be0.firebaseapp.com",
            projectId: "tierlistpro-46be0",
            storageBucket: "tierlistpro-46be0.firebasestorage.app",
            messagingSenderId: "1041684213363",
            appId: "1:1041684213363:web:a1e935fc08f03039a3c406",
            measurementId: "G-4LCGTZV5Q6"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const dbCloud = firebase.firestore();
        let currentUser = null;

        auth.onAuthStateChanged(user => {
            currentUser = user;
            const btnLogin = document.getElementById('btn-login');
            const userProfile = document.getElementById('user-profile');
            
            if (user) {
                btnLogin.style.display = 'none';
                userProfile.style.display = 'flex';
                document.getElementById('user-avatar').src = user.photoURL || '';
                document.getElementById('user-name').innerText = user.displayName;
            } else {
                btnLogin.style.display = 'flex';
                userProfile.style.display = 'none';
            }
            if (db) loadMenu(); 
        });

        function loginWithGoogle() {
            showLoading("ƒêang k·∫øt n·ªëi Cloud...");
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => {
                hideLoading();
                alert("L·ªói ƒëƒÉng nh·∫≠p: " + error.message);
            });
        }

        function logoutFromCloud() {
            auth.signOut().then(() => showToast("üëã ƒê√£ ƒëƒÉng xu·∫•t kh·ªèi Cloud"));
        }

        // ----------------------------------------------------
        // 1. CORE ENGINE & UTILS (LOCAL DB)
        // ----------------------------------------------------
        const DB_NAME = 'TierMaker_V26_Pro'; 
        let db, currentListData, selectedImgObj = null, editingTierIndex = -1, draggedItem = null, draggedRowIdx = null;
        let currentPlaceholder = null; 
        let stateHistory = [], historyIndex = -1;
        let saveTimeout, toastTimeout, confirmAction = null, confirmCancelAction = null;
        let isDirty = false;
        
        const autoSaveInterval = setInterval(() => {
            if (isDirty && currentListData) { saveListSilent(currentListData); showToast('üíæ ƒê√£ l∆∞u'); isDirty = false; }
        }, 3000);

        function markDirty() { isDirty = true; }
        function escapeHTML(str) { return !str ? '' : str.replace(/[&<>'"]/g, tag => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[tag] || tag)); }
        function initTheme() { const savedTheme = localStorage.getItem('theme') || 'dark'; document.documentElement.setAttribute('data-theme', savedTheme); updateThemeIcon(savedTheme); }
        function toggleTheme() { const current = document.documentElement.getAttribute('data-theme'); const target = current === 'dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-theme', target); localStorage.setItem('theme', target); updateThemeIcon(target); }
        function updateThemeIcon(theme) { const btn = document.querySelector('.theme-toggle'); if (btn) btn.innerText = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è'; document.getElementById('meta-theme-color').content = theme === 'dark' ? '#09090b' : '#f4f4f5'; }

        window.onload = () => { 
            initTheme();
            const req = indexedDB.open(DB_NAME, 1); 
            req.onupgradeneeded = e => { e.target.result.createObjectStore('lists', {keyPath:'id'}); };
            req.onsuccess = e => {
                db = e.target.result;
                loadMenu();
                initGlobalFileDrop();
                initKeyboardShortcuts();
                initGlobalClickAndDrop();
            };
        };
        
        function showToast(msg) { const toast = document.getElementById('toast'); toast.innerText = msg; toast.classList.add('show'); clearTimeout(toastTimeout); toastTimeout = setTimeout(() => toast.classList.remove('show'), 2000); }
        function openConfirm(title, desc, onConfirm, onCancel = null) { document.getElementById('confirm-title').innerText = title; document.getElementById('confirm-desc').innerText = desc; confirmAction = onConfirm; confirmCancelAction = onCancel; document.getElementById('confirm-modal').style.display = 'flex'; }
        function execConfirm() { if (confirmAction) confirmAction(); closeModal('confirm-modal'); }
        function execCancel() { if (confirmCancelAction) confirmCancelAction(); closeModal('confirm-modal'); }

        // ----------------------------------------------------
        // 2. DATA SYNC (CLOUD & LOCAL)
        // ----------------------------------------------------
        function loadMenu() {
            const container = document.getElementById('list-container');
            container.innerHTML = '<div style="grid-column: 1/-1; text-align:center;">ƒêang t·∫£i d·ªØ li·ªáu...</div>';
            
            if (currentUser) {
                dbCloud.collection('users').doc(currentUser.uid).collection('tierlists').get()
                .then(snapshot => {
                    const list = [];
                    snapshot.forEach(doc => list.push(doc.data()));
                    hideLoading();
                    renderMenuHTML(list, container, true);
                }).catch(err => {
                    hideLoading();
                    container.innerHTML = 'L·ªói k·∫øt n·ªëi Cloud: ' + err.message;
                });
            } else {
                try {
                    db.transaction(['lists']).objectStore('lists').getAll().onsuccess = e => {
                        renderMenuHTML(e.target.result, container, false);
                    };
                } catch (err) {}
            }
        }

        function renderMenuHTML(list, container, isCloud) {
            if (list.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding: 60px 20px; color: var(--text-muted); grid-column: 1/-1; font-size: 1.1rem;">üìÅ<br><br>B·∫°n ch∆∞a c√≥ b·∫£ng x·∫øp h·∫°ng n√†o.<br>${isCloud ? 'D·ªØ li·ªáu ƒë√°m m√¢y ƒëang tr·ªëng.' : 'H√£y ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·ªìng b·ªô, ho·∫∑c t·∫°o m·ªõi ngay Offline!'}</div>`;
                return;
            }
            let html = '';
            list.forEach((l, index) => {
                const safeName = escapeHTML(l.name);
                const delay = index * 0.05;
                const cloudIcon = isCloud ? '<span style="font-size: 0.8em; opacity:0.7" title="ƒê√£ l∆∞u tr√™n Cloud">‚òÅÔ∏è</span>' : '';
                html += `
                <div class="list-item" style="animation-delay: ${delay}s" tabindex="0" onclick="openList('${l.id}')">
                    <button class="btn-delete-list" onclick="deleteSingleList(event, '${l.id}', '${safeName}')">üóëÔ∏è</button>
                    <img src="${l.thumbnail || ''}" alt="Thumbnail" style="width:100%; height:180px; object-fit:cover; object-position:top; background:#000;">
                    <div class="list-info-wrap">
                        <h3 style="margin:0; font-size:1rem; flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${cloudIcon} ${safeName}</h3>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function saveListSilent(d) {
            try {
                d.updatedAt = new Date().toISOString();
                db.transaction(['lists'], 'readwrite').objectStore('lists').put(d);
                if (currentUser) {
                    dbCloud.collection('users').doc(currentUser.uid).collection('tierlists').doc(d.id).set(d).catch(err => {
                        console.error("L·ªói ƒë·ªìng b·ªô Cloud t·ª± ƒë·ªông:", err);
                        // showToast("‚ö†Ô∏è Kh√¥ng th·ªÉ l∆∞u l√™n Cloud. Dung l∆∞·ª£ng c√≥ th·ªÉ qu√° l·ªõn.");
                    });
                }
            } catch(e) {}
        }

        function deleteSingleList(e, id, name) {
            e.stopPropagation();
            openConfirm("X√≥a B·∫£ng", `X√≥a b·∫£ng "${name}"?`, () => {
                showLoading("ƒêang x√≥a...");
                try {
                    const tx = db.transaction(['lists'], 'readwrite');
                    tx.objectStore('lists').delete(id);
                } catch(e){}
                if (currentUser) {
                    dbCloud.collection('users').doc(currentUser.uid).collection('tierlists').doc(id).delete()
                    .then(() => { hideLoading(); loadMenu(); }).catch(() => { hideLoading(); loadMenu(); });
                } else {
                    hideLoading(); loadMenu();
                }
            });
        }

        function openList(id) {
            showLoading('ƒêang m·ªü...');
            if (currentUser) {
                dbCloud.collection('users').doc(currentUser.uid).collection('tierlists').doc(id).get()
                .then(doc => {
                    if (doc.exists) { currentListData = doc.data(); setupEditorAfterLoad(); } 
                    else { hideLoading(); alert("B·∫£ng kh√¥ng t·ªìn t·∫°i tr√™n Cloud!"); }
                });
            } else {
                try {
                    db.transaction(['lists']).objectStore('lists').get(id).onsuccess = e => {
                        if(e.target.result) { currentListData = e.target.result; setupEditorAfterLoad(); } 
                        else { hideLoading(); alert("B·∫£ng kh√¥ng t·ªìn t·∫°i!"); }
                    };
                } catch (err) { hideLoading(); }
            }
        }

        function setupEditorAfterLoad() {
            stateHistory = [JSON.stringify(currentListData)];
            historyIndex = 0;
            isDirty = false;
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('editor-screen').classList.remove('hidden');
            document.getElementById('list-name').value = currentListData.name;
            renderBoard();
            hideLoading();
        }

        // ----------------------------------------------------
        // 3. EDITOR & DRAG-DROP
        // ----------------------------------------------------
        function initGlobalClickAndDrop() {
            const handleOutsideClick = (e) => {
                if (selectedImgObj) {
                    const isClickInsideImage = e.target.closest('.img-wrap');
                    const isClickInsideControl = e.target.closest('#resize-control');
                    if (!isClickInsideImage && !isClickInsideControl) deselectImg();
                }
            };
            document.addEventListener('mousedown', handleOutsideClick);
            document.addEventListener('touchstart', handleOutsideClick, {passive: true});
        }
        function initGlobalFileDrop() { 
            const overlay = document.getElementById('drop-overlay'); 
            window.addEventListener('dragenter', e => { e.preventDefault(); if (draggedItem) return; if (e.dataTransfer.types && e.dataTransfer.types.includes("Files")) { e.dataTransfer.dropEffect = 'copy'; overlay.style.display = 'flex'; } }); 
            overlay.addEventListener('dragleave', e => { e.preventDefault(); overlay.style.display = 'none'; }); 
            window.addEventListener('dragover', e => { e.preventDefault(); if (draggedItem) { e.dataTransfer.dropEffect = 'move'; return; } e.dataTransfer.dropEffect = 'copy'; });
            window.addEventListener('drop', e => { e.preventDefault(); if (draggedItem) return; overlay.style.display = 'none'; if (e.dataTransfer.files && e.dataTransfer.files.length > 0) { if (!currentListData) { alert("Vui l√≤ng m·ªü b·∫£ng tr∆∞·ªõc khi th√™m ·∫£nh!"); return; } handleFiles({target: {files: e.dataTransfer.files}}); } }); 
        }
        function initKeyboardShortcuts() {
            window.addEventListener('keydown', e => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                if (e.ctrlKey || e.metaKey) { if (e.key.toLowerCase() === 'z') { e.preventDefault(); undo(); } if (e.key.toLowerCase() === 'y') { e.preventDefault(); redo(); } if (e.key.toLowerCase() === 's') { e.preventDefault(); if (currentListData) { saveListSilent(currentListData); showToast('üíæ ƒê√£ l∆∞u th·ªß c√¥ng'); isDirty = false; } } }
                if (e.key === 'Delete' || e.key === 'Backspace') { if (selectedImgObj) { e.preventDefault(); deleteSelected(); } }
                if (e.key === 'Escape') { if (document.body.classList.contains('zen-mode')) toggleZenMode(); if (selectedImgObj) deselectImg(); document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); }
            });
        }
        function commitChange() { pushHistory(); renderBoard(); markDirty(); }
        function commitChangeSilent() { pushHistory(); markDirty(); }
        function pushHistory() { const s = JSON.stringify(currentListData); if (stateHistory[historyIndex] !== s) { stateHistory = stateHistory.slice(0, historyIndex+1); stateHistory.push(s); historyIndex++; if (stateHistory.length > 15) { stateHistory.shift(); historyIndex--; } } }
        function undo() { if (historyIndex > 0) { historyIndex--; currentListData = JSON.parse(stateHistory[historyIndex]); renderBoard(); markDirty(); showToast("‚Ü©Ô∏è ƒê√£ ho√†n t√°c"); } }
        function redo() { if (historyIndex < stateHistory.length-1) { historyIndex++; currentListData = JSON.parse(stateHistory[historyIndex]); renderBoard(); markDirty(); showToast("‚Ü™Ô∏è ƒê√£ l√†m l·∫°i"); } }

        function getInsertionNode(container, clientX, clientY) {
            const elements = [...container.querySelectorAll('.img-wrap:not(.dragging):not(.drag-placeholder)')];
            for (let i = 0; i < elements.length; i++) {
                const box = elements[i].getBoundingClientRect();
                if (clientY >= box.top && clientY <= box.bottom) {
                    if (clientX < box.left + box.width / 2) return elements[i];
                } else if (clientY < box.top) { return elements[i]; }
            }
            return null;
        }

        function renderBoard() {
            try {
                const board = document.getElementById('tier-board'); board.innerHTML = '';
                const hEl = document.getElementById('tier-header'); hEl.innerText = currentListData.name; hEl.style.display = currentListData.headerVisible === false ? 'none' : 'block';
                currentListData.tiers.forEach((t, i) => {
                    const row = document.createElement('div'); row.className = 'tier-row'; row.style.backgroundColor = t.color; row.draggable = true; 
                    row.ondragstart = e => { if (e.target.closest('.img-wrap')) return; draggedRowIdx = i; e.dataTransfer.effectAllowed = 'move'; };
                    row.ondragover = e => { e.preventDefault(); if (draggedRowIdx !== null) { e.dataTransfer.dropEffect = 'move'; e.currentTarget.style.borderTop = "3px solid #10b981"; } };
                    row.ondragleave = e => { if (draggedRowIdx !== null) e.currentTarget.style.borderTop = ""; };
                    row.ondrop = e => { e.preventDefault(); e.currentTarget.style.borderTop = ""; if (draggedRowIdx !== null) { const tmp = currentListData.tiers.splice(draggedRowIdx, 1)[0]; currentListData.tiers.splice(i, 0, tmp); draggedRowIdx = null; commitChange(); } };
                    const labelWrap = document.createElement('div'); labelWrap.className = 'tier-label-wrap';
                    const label = document.createElement('div'); label.className = 'tier-label'; label.innerText = t.name; label.onclick = () => openEditModal(i); labelWrap.appendChild(label);
                    const content = document.createElement('div'); content.className = 'tier-content';
                    content.ondragover = e => { e.preventDefault(); if (draggedItem && draggedItem.type !== 'row') { e.dataTransfer.dropEffect = 'move'; if (currentPlaceholder) { const afterElement = getInsertionNode(content, e.clientX, e.clientY); if (afterElement !== currentPlaceholder.nextElementSibling) { if (afterElement) content.insertBefore(currentPlaceholder, afterElement); else content.appendChild(currentPlaceholder); } } } };
                    content.ondrop = e => { e.preventDefault(); if (draggedItem && draggedItem.type !== 'row' && currentPlaceholder && currentPlaceholder.parentNode === content) { const elements = [...content.querySelectorAll('.img-wrap:not(.dragging)')]; const dropIndex = elements.indexOf(currentPlaceholder); let oldArray = (draggedItem.type === 'tier') ? currentListData.tiers[draggedItem.r].items : currentListData.dock; let newArray = currentListData.tiers[i].items; oldArray.splice(draggedItem.i, 1); newArray.splice(dropIndex, 0, draggedItem.data); commitChange(); } };
                    t.items.forEach((img, idx) => content.appendChild(createImg(img, 'tier', i, idx)));
                    row.appendChild(labelWrap); row.appendChild(content); board.appendChild(row);
                });
                const dock = document.getElementById('dock'); dock.innerHTML = '';
                dock.ondragover = e => { e.preventDefault(); if(draggedItem && draggedItem.type !== 'row') { e.dataTransfer.dropEffect = 'move'; if (currentPlaceholder) { const afterElement = getInsertionNode(dock, e.clientX, e.clientY); if (afterElement !== currentPlaceholder.nextElementSibling) { if (afterElement) dock.insertBefore(currentPlaceholder, afterElement); else dock.appendChild(currentPlaceholder); } } } };
                dock.ondrop = e => { e.preventDefault(); if (draggedItem && draggedItem.type !== 'row' && currentPlaceholder && currentPlaceholder.parentNode === dock) { const elements = [...dock.querySelectorAll('.img-wrap:not(.dragging)')]; const dropIndex = elements.indexOf(currentPlaceholder); let oldArray = (draggedItem.type === 'tier') ? currentListData.tiers[draggedItem.r].items : currentListData.dock; let newArray = currentListData.dock; oldArray.splice(draggedItem.i, 1); newArray.splice(dropIndex, 0, draggedItem.data); commitChange(); } };
                currentListData.dock.forEach((img, idx) => dock.appendChild(createImg(img, 'dock', null, idx)));
            } catch (err) {}
        }

        function createImg(data, type, r, i) {
            const wrap = document.createElement('div'); wrap.className = 'img-wrap'; wrap.style.height = (type==='tier' ? data.h : 85) + 'px';
            const img = document.createElement('img'); img.src = data.src; img.className = 'img-item'; img.style.height = (type==='tier' ? data.h : 85) + 'px'; wrap.appendChild(img);
            if (data.caption) { const c = document.createElement('div'); c.className = 'img-caption'; c.innerText = data.caption; wrap.appendChild(c); }
            wrap.onclick = e => { e.stopPropagation(); clickImg(wrap, data, type, r, i); };
            wrap.draggable = true;
            wrap.ondragstart = e => { e.stopPropagation(); draggedItem = {data, type, r, i}; e.dataTransfer.effectAllowed = 'move'; const tz = document.getElementById('trash-zone'); tz.style.display='flex'; tz.classList.remove('hover'); setTimeout(() => { wrap.classList.add('dragging'); currentPlaceholder = wrap.cloneNode(true); currentPlaceholder.classList.remove('dragging', 'selected'); currentPlaceholder.classList.add('drag-placeholder'); }, 0); };
            wrap.ondragend = () => { draggedItem = null; document.getElementById('trash-zone').style.display='none'; wrap.classList.remove('dragging'); if (currentPlaceholder && currentPlaceholder.parentNode) { currentPlaceholder.parentNode.removeChild(currentPlaceholder); } currentPlaceholder = null; };
            return wrap;
        }

        const tz = document.getElementById('trash-zone');
        tz.ondragover = e => { e.preventDefault(); if(draggedItem) { e.dataTransfer.dropEffect = 'move'; tz.classList.add('hover'); } };
        tz.ondragleave = () => tz.classList.remove('hover');
        tz.ondrop = () => { if (draggedItem) { let oldArray = (draggedItem.type === 'tier') ? currentListData.tiers[draggedItem.r].items : currentListData.dock; oldArray.splice(draggedItem.i, 1); commitChange(); tz.classList.remove('hover'); } };

        function clickImg(dom, data, type, r, i) { if (!selectedImgObj) { selectedImgObj = {dom, data, type, r, i}; dom.classList.add('selected'); document.getElementById('resize-control').classList.remove('hidden'); document.getElementById('size-slider').value = data.h; document.getElementById('size-val').innerText = data.h + 'px'; } else if (selectedImgObj.dom === dom) { deselectImg(); } }
        function deselectImg() { if (selectedImgObj) { selectedImgObj.dom.classList.remove('selected'); selectedImgObj = null; document.getElementById('resize-control').classList.add('hidden'); } }
        function resizeSelectedImg(h) { if (selectedImgObj) { h = parseInt(h); selectedImgObj.data.h = h; selectedImgObj.dom.style.height = h+'px'; selectedImgObj.dom.querySelector('.img-item').style.height = h+'px'; document.getElementById('size-val').innerText = h+'px'; document.getElementById('size-slider').value = h; } }
        function adjustSize(d) { if (selectedImgObj) { let newH = parseInt(document.getElementById('size-slider').value) + d; newH = Math.max(40, Math.min(300, newH)); resizeSelectedImg(newH); } }
        function applyToAll() { const h = selectedImgObj.data.h; currentListData.tiers.forEach(t => t.items.forEach(i => i.h = h)); currentListData.dock.forEach(i => i.h = h); commitChange(); }
        function showLoading(text) { document.getElementById('loading-text').innerText = text; document.getElementById('loading-overlay').style.display='flex'; }
        function hideLoading() { document.getElementById('loading-overlay').style.display='none'; }
        function saveImage() { deselectImg(); showLoading('ƒêang xu·∫•t ·∫£nh 4K...'); setTimeout(() => { html2canvas(document.getElementById('capture-area'), { scale: 4, backgroundColor: null, useCORS: true }).then(c => { const a = document.createElement('a'); a.download = 'TierList.png'; a.href = c.toDataURL('image/png', 1.0); a.click(); hideLoading(); showToast("‚úÖ L∆∞u ·∫£nh th√†nh c√¥ng"); }).catch(err => { hideLoading(); alert('L·ªói xu·∫•t ·∫£nh: L·ªói CORS.'); }); }, 100); }
        
        function processFilesArray(filesToProcess) {
            if (filesToProcess.length === 0) { document.getElementById('imgInput').value = ''; return; }
            showLoading("ƒêang x·ª≠ l√Ω ·∫£nh..."); let processed = 0;
            filesToProcess.forEach(f => {
                const r = new FileReader();
                r.onload = ev => {
                    const i = new Image(); i.src = ev.target.result;
                    i.onload = () => { try { const c = document.createElement('canvas'); const x = c.getContext('2d'); const M = 1500; let w = i.width; let h = i.height; if (w > M) { h *= (M/w); w = M; } c.width = w; c.height = h; x.drawImage(i, 0, 0, w, h); currentListData.dock.push({ src: c.toDataURL('image/jpeg', 0.8), h: 85, name: f.name }); } catch(err) {} finally { processed++; if (processed === filesToProcess.length) { commitChange(); hideLoading(); } } };
                    i.onerror = () => { processed++; if (processed === filesToProcess.length) { commitChange(); hideLoading(); } }
                }; r.readAsDataURL(f);
            }); document.getElementById('imgInput').value = '';
        }

        function handleFiles(e) {
            const files = Array.from(e.target.files).filter(f => { if (!f.type.startsWith('image/')) { alert(`‚ùå File "${escapeHTML(f.name)}" kh√¥ng ph·∫£i h√¨nh ·∫£nh.`); return false; } return true; });
            if (files.length === 0) { e.target.value = ''; return; }
            const existingNames = new Set();
            if (currentListData) { currentListData.dock.forEach(img => { if(img.name) existingNames.add(img.name); }); currentListData.tiers.forEach(t => { t.items.forEach(img => { if(img.name) existingNames.add(img.name); }); }); }
            const newFiles = [], duplicateFiles = [];
            files.forEach(f => { if (existingNames.has(f.name)) duplicateFiles.push(f); else newFiles.push(f); });
            if (duplicateFiles.length > 0) { const dupNames = duplicateFiles.map(f => escapeHTML(f.name)).slice(0, 3).join(', '); const extraDup = duplicateFiles.length > 3 ? ` v√† ${duplicateFiles.length - 3} file kh√°c` : ''; openConfirm("Ph√°t hi·ªán tr√πng l·∫∑p", `B·∫°n c√≥ mu·ªën up TR√ôNG L·∫∂P kh√¥ng?`, () => processFilesArray([...newFiles, ...duplicateFiles]), () => processFilesArray(newFiles) ); } else { processFilesArray(newFiles); }
        }

        function toggleZenMode() { document.body.classList.toggle('zen-mode'); if (document.body.classList.contains('zen-mode')) { document.getElementById('exit-zen-btn').style.display='block'; } else { document.getElementById('exit-zen-btn').style.display='none'; } }
        function openHeaderModal() { const inputName = document.getElementById('list-name'); inputName.focus(); inputName.select(); }
        function openCreateModal() { document.getElementById('create-modal-overlay').style.display='flex'; document.getElementById('new-template-name').focus(); }
        function openHelpModal() { document.getElementById('help-modal').style.display='flex'; }
        function confirmCreateList() {
            const name = document.getElementById('new-template-name').value.trim() || 'B·∫£ng m·ªõi';
            showLoading("ƒêang t·∫°o...");
            setTimeout(() => {
                const newList = { id: 'list_'+Date.now(), name: name, tiers: [{name:'S', color:'#FF7F7F', items:[]}], dock: [] };
                saveListSilent(newList); loadMenu(); closeModal('create-modal-overlay'); document.getElementById('new-template-name').value = ''; hideLoading();
            }, 300);
        }

        function openEditModal(i) { editingTierIndex = i; const t = currentListData.tiers[i]; document.getElementById('edit-name').value = t.name; document.getElementById('edit-color-picker').value = t.color; document.getElementById('modal-overlay').style.display='flex'; document.getElementById('edit-name').focus(); }
        function setTierColor(color) { document.getElementById('edit-color-picker').value = color; }
        function saveTierEdit() { currentListData.tiers[editingTierIndex].name = document.getElementById('edit-name').value; currentListData.tiers[editingTierIndex].color = document.getElementById('edit-color-picker').value; closeModal('modal-overlay'); commitChange(); }
        function moveTierUp() { if (editingTierIndex > 0) { const tmp = currentListData.tiers[editingTierIndex]; currentListData.tiers[editingTierIndex] = currentListData.tiers[editingTierIndex - 1]; currentListData.tiers[editingTierIndex - 1] = tmp; editingTierIndex--; commitChange(); } }
        function moveTierDown() { if (editingTierIndex < currentListData.tiers.length - 1) { const tmp = currentListData.tiers[editingTierIndex]; currentListData.tiers[editingTierIndex] = currentListData.tiers[editingTierIndex + 1]; currentListData.tiers[editingTierIndex + 1] = tmp; editingTierIndex++; commitChange(); } }
        function deleteTier() { openConfirm("X√≥a H√†ng", "X√≥a h√†ng n√†y?", () => { currentListData.tiers.splice(editingTierIndex, 1); closeModal('modal-overlay'); commitChange(); }); }
        function addNewTier() { currentListData.tiers.push({name:'NEW', color:'#1a1a1a', items:[]}); commitChange(); }
        function toggleHeader() { currentListData.headerVisible = currentListData.headerVisible === false ? true : false; commitChange(); }
        function resetBoard() { openConfirm("Reset", "ƒê∆∞a to√†n b·ªô ·∫£nh v·ªÅ Kho (Dock)?", () => { currentListData.tiers.forEach(t => { currentListData.dock.push(...t.items); t.items = []; }); commitChange(); }); }
        function openCaptionModal() { if (selectedImgObj) { document.getElementById('caption-input').value = selectedImgObj.data.caption || ''; document.getElementById('caption-modal-overlay').style.display='flex'; document.getElementById('caption-input').focus(); } }
        function saveCaption() { selectedImgObj.data.caption = document.getElementById('caption-input').value; closeModal('caption-modal-overlay'); commitChange(); }
        function deleteSelected() { let oldArray = (selectedImgObj.type === 'tier') ? currentListData.tiers[selectedImgObj.r].items : currentListData.dock; oldArray.splice(selectedImgObj.i, 1); commitChange(); deselectImg(); }
        function moveToDock() { let oldArray = (selectedImgObj.type === 'tier') ? currentListData.tiers[selectedImgObj.r].items : currentListData.dock; oldArray.splice(selectedImgObj.i, 1); currentListData.dock.push(selectedImgObj.data); commitChange(); deselectImg(); }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function debounceSaveName() { clearTimeout(saveTimeout); saveTimeout = setTimeout(() => { currentListData.name = document.getElementById('list-name').value; commitChangeSilent(); document.getElementById('tier-header').innerText = currentListData.name; }, 500); }
        
        async function backToMenu() {
            deselectImg(); showLoading('ƒêang l∆∞u...');
            try {
                if (isDirty) saveListSilent(currentListData);
                const canvas = await html2canvas(document.getElementById('capture-area'), { scale: 1, backgroundColor: '#000', useCORS: true });
                currentListData.thumbnail = canvas.toDataURL('image/jpeg', 0.6);
                saveListSilent(currentListData);
            } catch (err) { } finally { currentListData = null; selectedImgObj = null; }
            hideLoading(); document.getElementById('editor-screen').classList.add('hidden'); document.getElementById('menu-screen').classList.remove('hidden'); loadMenu();
        }

        // ----------------------------------------------------
        // 4. BACKUP / EXPORT / IMPORT ENGINE (C√ì B·∫ÆT L·ªñI FIREBASE)
        // ----------------------------------------------------
        function openBackupMenu() { document.getElementById('backup-modal-overlay').style.display='flex'; }
        
        function exportData() { 
            try { 
                db.transaction(['lists']).objectStore('lists').getAll().onsuccess = e => { 
                    const data = JSON.stringify(e.target.result); 
                    const blob = new Blob([data], {type: "application/json"}); 
                    const url = URL.createObjectURL(blob); 
                    const a = document.createElement('a'); 
                    a.href = url; a.download = `TierMaker_Backup_${Date.now()}.json`; a.click(); 
                    setTimeout(() => URL.revokeObjectURL(url), 1000); 
                }; 
            } catch (err) {} 
        }

        function importData(e) { 
            const file = e.target.files[0]; 
            if (!file) return; 
            const reader = new FileReader(); 
            reader.onload = ev => { 
                try { 
                    const data = JSON.parse(ev.target.result); 
                    const tx = db.transaction(['lists'], 'readwrite'); 
                    const store = tx.objectStore('lists'); 
                    
                    showLoading("ƒêang kh√¥i ph·ª•c & ƒê·ªìng b·ªô...");
                    let cloudTasks = [];

                    data.forEach(item => {
                        store.put(item);
                        if (currentUser) {
                            cloudTasks.push(dbCloud.collection('users').doc(currentUser.uid).collection('tierlists').doc(item.id).set(item));
                        }
                    }); 
                    
                    tx.oncomplete = () => { 
                        if (currentUser && cloudTasks.length > 0) {
                            Promise.all(cloudTasks).then(() => {
                                hideLoading();
                                alert('‚úÖ ƒê√£ kh√¥i ph·ª•c v√† ƒê·ªìng b·ªô l√™n Cloud!'); 
                                loadMenu(); 
                                closeModal('backup-modal-overlay'); 
                            }).catch(err => {
                                hideLoading();
                                console.error("L·ªói Firebase:", err);
                                alert("‚ùå L·ªói ƒë·ªìng b·ªô l√™n Cloud:\n" + err.message + "\n\n(D·ªØ li·ªáu v·∫´n ƒë∆∞·ª£c kh√¥i ph·ª•c ·ªü ch·∫ø ƒë·ªô Offline trong m√°y c·ªßa b·∫°n)");
                                loadMenu();
                                closeModal('backup-modal-overlay');
                            });
                        } else {
                            hideLoading();
                            alert('‚úÖ Kh√¥i ph·ª•c Local th√†nh c√¥ng!'); 
                            loadMenu(); 
                            closeModal('backup-modal-overlay'); 
                        }
                    }; 
                } catch(err) { hideLoading(); alert('‚ùå File b·ªã l·ªói ƒë·ªãnh d·∫°ng!'); } 
            }; 
            reader.readAsText(file); e.target.value = ''; 
        }

        async function copyDataToClipboard() { 
            try { 
                db.transaction(['lists']).objectStore('lists').getAll().onsuccess = async e => { 
                    try { await navigator.clipboard.writeText(JSON.stringify(e.target.result)); alert('‚úÖ ƒê√£ Copy!'); } catch (err) { alert('L·ªói copy, m√£ qu√° d√†i. Vui l√≤ng d√πng T·∫£i File.'); } 
                }; 
            } catch (err) {} 
        }

        async function pasteDataFromClipboard() { 
            try { 
                const text = await navigator.clipboard.readText(); 
                if (!text) { return; } 
                processPastedString(text); 
            } catch (err) { 
                document.getElementById('manual-paste-textarea').value = ''; 
                document.getElementById('manual-paste-modal').style.display = 'flex'; 
                document.getElementById('manual-paste-textarea').focus(); 
            } 
        }

        function processManualPaste() { 
            const text = document.getElementById('manual-paste-textarea').value; 
            if (!text) return; 
            closeModal('manual-paste-modal'); processPastedString(text); 
        }

        function processPastedString(text) { 
            try { 
                const data = JSON.parse(text); 
                const tx = db.transaction(['lists'], 'readwrite'); 
                const store = tx.objectStore('lists'); 
                
                showLoading("ƒêang kh√¥i ph·ª•c & ƒê·ªìng b·ªô...");
                let cloudTasks = [];

                data.forEach(item => {
                    store.put(item);
                    if (currentUser) {
                        cloudTasks.push(dbCloud.collection('users').doc(currentUser.uid).collection('tierlists').doc(item.id).set(item));
                    }
                }); 
                
                tx.oncomplete = () => { 
                    if (currentUser && cloudTasks.length > 0) {
                        Promise.all(cloudTasks).then(() => {
                            hideLoading();
                            alert('‚úÖ ƒê√£ kh√¥i ph·ª•c v√† ƒê·ªìng b·ªô l√™n Cloud!'); 
                            loadMenu(); 
                            closeModal('backup-modal-overlay'); 
                        }).catch(err => {
                            hideLoading();
                            console.error("L·ªói Firebase:", err);
                            alert("‚ùå L·ªói ƒë·ªìng b·ªô l√™n Cloud:\n" + err.message + "\n\n(D·ªØ li·ªáu v·∫´n ƒë∆∞·ª£c kh√¥i ph·ª•c ·ªü ch·∫ø ƒë·ªô Offline trong m√°y c·ªßa b·∫°n)");
                            loadMenu();
                            closeModal('backup-modal-overlay');
                        });
                    } else {
                        hideLoading();
                        alert('‚úÖ Kh√¥i ph·ª•c Local th√†nh c√¥ng!'); 
                        loadMenu(); 
                        closeModal('backup-modal-overlay'); 
                    }
                }; 
            } catch(e) { hideLoading(); alert('‚ùå M√£ kh√¥ng h·ª£p l·ªá!'); } 
        }

        function wipeAllData() { 
            openConfirm("C·∫¢NH B√ÅO", "X√≥a TO√ÄN B·ªò d·ªØ li·ªáu local?", () => { 
                try { db.transaction(['lists'], 'readwrite').objectStore('lists').clear().onsuccess = () => location.reload(); } catch(e) {} 
            }); 
        }
    </script>
</body>
</html>
