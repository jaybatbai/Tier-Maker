<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#09090b">
    
    <title>Tier List Maker Pro</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* =========================================
           1. PREMIUM THEME & VARIABLES
           ========================================= */
        :root {
            --bg-base: #09090b; 
            --bg-surface: #18181b; 
            --bg-elevated: #27272a;
            --border-color: #27272a;
            --border-hover: #3f3f46;
            
            --primary: #10b981; 
            --primary-hover: #059669;
            --accent: #3b82f6; 
            --danger: #ef4444; 
            --danger-bg: rgba(239, 68, 68, 0.1);
            
            --text-main: #f4f4f5;
            --text-muted: #a1a1aa;
            
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
            --radius-pill: 9999px;
            --shadow-float: 0 20px 40px -10px rgba(0,0,0,0.7);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--bg-elevated); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        body { 
            background: var(--bg-base); color: var(--text-main); 
            margin: 0; padding: 0; padding-bottom: 100px;
            overscroll-behavior: none; line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }
        .hidden { display: none !important; }

        #app-container {
            width: 100%; max-width: 960px; margin: 0 auto; 
            background: var(--bg-base); min-height: 100vh;
            border-left: 1px solid var(--border-color); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; position: relative;
        }

        #drop-overlay {
            position: fixed; inset: 0; background: rgba(16, 185, 129, 0.85); z-index: 9999;
            display: none; align-items: center; justify-content: center;
            color: white; font-size: 1.5rem; font-weight: 600; letter-spacing: -0.5px;
            backdrop-filter: blur(8px); border: 8px solid rgba(255,255,255,0.2);
        }

        /* =========================================
           2. MENU SCREEN
           ========================================= */
        #menu-screen { padding: 60px 30px; flex: 1; display: flex; flex-direction: column; align-items: center; }
        .app-title { color: var(--text-main); font-size: 2.5rem; margin: 0 0 40px 0; font-weight: 800; letter-spacing: -1px; text-transform: uppercase; }
        .app-title span { color: var(--primary); }
        
        .menu-actions { display: flex; flex-direction: column; gap: 12px; width: 100%; max-width: 380px; margin-bottom: 50px; }
        .btn-create { width: 100%; padding: 16px; background: var(--primary); color: #fff; font-weight: 600; border: none; border-radius: var(--radius-md); font-size: 1.05rem; cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-create:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3); }
        
        .btn-data { width: 100%; padding: 14px; background: var(--bg-surface); color: var(--text-main); border: 1px solid var(--border-color); border-radius: var(--radius-md); font-weight: 500; cursor: pointer; transition: 0.2s; font-size: 0.95rem; }
        .btn-data:hover { border-color: var(--text-muted); background: var(--bg-elevated); }

        #list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; width: 100%; }
        .list-item { background: var(--bg-surface); border-radius: var(--radius-lg); overflow: hidden; border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; }
        .list-item:hover { border-color: var(--border-hover); transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.5); }
        .list-thumb { width: 100%; height: 140px; object-fit: cover; border-bottom: 1px solid var(--border-color); background: #000; }
        .list-placeholder { width: 100%; height: 140px; background: var(--bg-base); display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 0.85rem; font-weight: 500; border-bottom: 1px solid var(--border-color); }
        .list-info-wrap { padding: 18px; display: flex; justify-content: space-between; align-items: center; }
        .list-info { flex: 1; overflow: hidden; } 
        .list-info h3 { margin: 0; font-size: 1.05rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-main); letter-spacing: -0.3px; } 
        .list-info p { margin: 4px 0 0; font-size: 0.8rem; color: var(--text-muted); }
        .btn-del-list { background: transparent; border: none; color: var(--text-muted); width: 32px; height: 32px; border-radius: var(--radius-sm); font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; line-height: 1; }
        .btn-del-list:hover { color: var(--danger); background: var(--danger-bg); }

        /* =========================================
           3. EDITOR SCREEN
           ========================================= */
        #editor-screen { display: flex; flex-direction: column; flex: 1; }
        .top-bar { background: rgba(9, 9, 11, 0.8); backdrop-filter: blur(12px); padding: 14px 24px; display: flex; gap: 16px; align-items: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border-color); }
        .btn-back { background: var(--bg-surface); color: var(--text-main); border: 1px solid var(--border-color); border-radius: var(--radius-pill); font-size: 0.9rem; padding: 6px 14px; cursor: pointer; font-weight: 500; transition: 0.2s; }
        .btn-back:hover { background: var(--bg-elevated); }
        .list-name-input { flex: 1; background: transparent; border: none; color: var(--text-main); font-size: 1.15rem; font-weight: 600; outline: none; padding: 6px 12px; border-radius: var(--radius-sm); transition: 0.2s; letter-spacing: -0.3px; }
        .list-name-input:focus, .list-name-input:hover { background: var(--bg-surface); }

        /* BOARD AREA */
        .capture-wrapper { padding: 20px; background: var(--bg-base); } 
        #capture-area { background: #000; display: flex; flex-direction: column; border-radius: var(--radius-md); overflow: hidden; border: 1px solid var(--border-color); }
        .board-header-style { text-align: center; font-size: 1.75rem; font-weight: 800; padding: 25px 15px; background: #000; color: #fff; text-transform: uppercase; letter-spacing: 2px; cursor: pointer; transition: background 0.2s; border-bottom: 1px solid var(--border-color); }
        .board-header-style:hover { background: #111; }
        
        #tier-board { display: flex; flex-direction: column; gap: 2px; background: var(--border-color); } 
        .tier-row { display: flex; min-height: 90px; background: var(--bg-base); transition: transform 0.2s; }
        .tier-row.dragging { opacity: 0.4; }
        .tier-label { width: 100px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: 800; color: #000; text-align: center; padding: 8px; word-break: break-word; cursor: pointer; transition: filter 0.2s; border-right: 1px solid rgba(0,0,0,0.2); letter-spacing: -0.5px; }
        .tier-label:hover { filter: brightness(0.85); }
        .tier-content { flex: 1; display: flex; flex-wrap: wrap; align-items: flex-start; background: #0a0a0c; padding: 2px; gap: 2px; align-content: flex-start; transition: background 0.2s; position: relative; }
        .tier-content.drag-over { background: var(--bg-surface); }
        
        .tier-content:empty::before, #dock:empty::before { content: "Kéo thả ảnh..."; color: var(--text-muted); font-weight: 500; font-size: 0.85rem; margin: auto; padding: 20px; border: 1px dashed var(--border-color); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; height: calc(100% - 10px); width: calc(100% - 10px); }
        .is-exporting .tier-content:empty::before, .is-exporting #dock:empty::before { display: none !important; content: none !important; }

        .board-footer-actions { display: flex; justify-content: center; gap: 12px; padding: 15px 24px; background: var(--bg-base); flex-wrap: wrap;}
        .btn-text-action { background: var(--bg-surface); border: 1px solid var(--border-color); color: var(--text-main); font-size: 0.8rem; font-weight: 500; padding: 8px 18px; border-radius: var(--radius-pill); cursor: pointer; transition: 0.2s; letter-spacing: 0.3px; }
        .btn-text-action:hover { background: var(--bg-elevated); border-color: var(--text-muted); }
        .btn-text-action.danger { color: var(--danger); }
        .btn-text-action.danger:hover { border-color: var(--danger); background: var(--danger-bg); }

        /* IMAGE */
        .img-item { height: 86px; width: auto; border-radius: 4px; display: block; cursor: pointer; transition: transform 0.15s ease, filter 0.15s, box-shadow 0.15s; }
        .img-item:hover { transform: scale(1.04); z-index: 5; position: relative; box-shadow: 0 8px 16px rgba(0,0,0,0.6); }
        .img-item.selected { outline: 3px solid var(--accent); outline-offset: -3px; z-index: 10; filter: brightness(1.1); transform: scale(1.04); }

        /* DOCK */
        .dock-container { background: var(--bg-base); padding: 24px; flex: 1; transition: background 0.2s; border-top: 1px solid var(--border-color); }
        .dock-container.drag-over { background: var(--bg-surface); }
        .dock-header-wrap { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .dock-header { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; letter-spacing: 0.5px; }
        .btn-clear-dock { background: transparent; border: none; color: var(--text-muted); font-size: 0.8rem; font-weight: 500; cursor: pointer; padding: 6px 12px; border-radius: var(--radius-pill); transition: 0.2s; }
        .btn-clear-dock:hover { color: var(--danger); background: var(--danger-bg); }

        #dock { display: flex; flex-wrap: wrap; gap: 6px; justify-content: flex-start; align-content: flex-start; padding-bottom: 80px; min-height: 100px; }
        #dock .img-item { height: 75px !important; width: auto !important; border-radius: 6px; border: 1px solid var(--border-color); }

        /* BOTTOM TOOLBAR */
        .bottom-toolbar { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 960px; background: rgba(9, 9, 11, 0.85); backdrop-filter: blur(16px); padding: 16px 24px; display: flex; gap: 16px; border-top: 1px solid var(--border-color); z-index: 200; }
        .btn-bottom { flex: 1; padding: 14px; border: none; border-radius: var(--radius-md); font-size: 0.95rem; font-weight: 600; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: 0.2s; letter-spacing: -0.3px;}
        .btn-save { background: var(--bg-surface); border: 1px solid var(--border-color); color: var(--text-main); } 
        .btn-save:hover { background: var(--bg-elevated); border-color: var(--text-muted); }
        .btn-add { background: var(--text-main); color: var(--bg-base); } 
        .btn-add:hover { background: #d4d4d8; }

        /* =========================================
           4. BẢNG ĐIỀU KHIỂN NỔI (ĐÃ CẢI TIẾN)
           ========================================= */
        #resize-control { 
            position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); 
            width: 90%; max-width: 420px; background: rgba(24, 24, 27, 0.95); 
            backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); 
            border-radius: var(--radius-lg); z-index: 250; padding: 20px; 
            display: flex; flex-direction: column; gap: 16px; 
            box-shadow: var(--shadow-float);
        }
        
        .size-slider-wrap { display: flex; align-items: center; gap: 10px; }
        .size-label { font-size: 0.8rem; color: var(--text-muted); font-weight: 500;}
        
        /* Nút Tinh chỉnh Size (+/-) */
        .btn-size-adjust {
            background: var(--bg-surface); border: 1px solid var(--border-color);
            color: var(--text-main); width: 30px; height: 30px; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; font-weight: 400; cursor: pointer; transition: 0.2s;
            line-height: 1; padding-bottom: 2px;
        }
        .btn-size-adjust:hover { background: var(--bg-elevated); }
        .btn-size-adjust:active { transform: scale(0.9); }

        .resize-slider { flex: 1; height: 4px; border-radius: 2px; background: var(--border-color); outline: none; -webkit-appearance: none; appearance: none;}
        .resize-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--text-main); cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .size-val { font-size: 0.85rem; font-family: monospace; color: var(--text-main); width: 45px; text-align: right; }
        
        .control-actions { display: flex; gap: 10px; }
        .btn-pill { flex: 1; padding: 12px 0; border-radius: var(--radius-md); border: none; font-weight: 500; font-size: 0.85rem; cursor: pointer; transition: 0.2s; }
        .btn-pill-dock { background: var(--bg-surface); color: var(--text-main); border: 1px solid var(--border-color); } .btn-pill-dock:hover { background: var(--bg-elevated); }
        .btn-pill-del { background: var(--danger-bg); color: var(--danger); } .btn-pill-del:hover { background: var(--danger); color: white; }
        .btn-pill-all { background: var(--bg-surface); color: var(--text-main); border: 1px solid var(--border-color); } .btn-pill-all:hover { background: var(--bg-elevated); }
        .btn-pill-close { background: transparent; color: var(--text-muted); width: 100%; padding: 8px; border: none; font-size: 0.9rem; font-weight: 500; cursor: pointer; margin-top: -5px;}
        .btn-pill-close:hover { color: var(--text-main); }

        /* =========================================
           5. MODALS (ĐÃ SỬA ĐẸP & CHUẨN)
           ========================================= */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 300; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal { background: var(--bg-surface); padding: 28px; border-radius: var(--radius-lg); width: 90%; max-width: 400px; border: 1px solid var(--border-color); box-shadow: var(--shadow-float); }
        .modal h2 { margin: 0 0 20px 0; color: var(--text-main); font-weight: 700; font-size: 1.3rem; letter-spacing: -0.5px;}
        .modal label { display: block; margin-top: 16px; color: var(--text-muted); font-weight: 500; font-size: 0.85rem; margin-bottom: 6px;}
        .modal input[type="text"], .modal textarea { width: 100%; padding: 14px; border-radius: var(--radius-md); border: 1px solid var(--border-color); background: var(--bg-base); color: white; font-size: 1rem; outline: none; font-weight: 500; transition: 0.2s; }
        .modal input[type="text"]:focus, .modal textarea:focus { border-color: var(--text-muted); }
        
        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin: 12px 0; }
        .circle { width: 38px; height: 38px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; transition: 0.2s; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.2); justify-self: center;}
        .circle:hover { transform: scale(1.1); }
        .circle.selected { border-color: var(--text-main); transform: scale(1.1); box-shadow: 0 0 15px rgba(255,255,255,0.2); }
        .hex-input-row { display: flex; align-items: center; background: var(--bg-base); padding: 6px 14px; border-radius: var(--radius-md); margin-top: 16px; border: 1px solid var(--border-color); }
        .hex-label { color: var(--text-muted); font-weight: 500; margin-right: 12px; font-size: 0.85rem; }
        .hex-field { flex: 1; background: transparent; border: none; color: var(--text-main); font-family: monospace; font-size: 1.05rem; text-transform: uppercase; outline: none; }
        
        .modal-btns { display: flex; flex-direction: column; gap: 10px; margin-top: 28px; }
        .modal-btns button { width: 100%; padding: 14px; border: none; border-radius: var(--radius-md); font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--text-main); color: var(--bg-base); } .btn-primary:hover { background: #e4e4e7; }
        .btn-secondary { background: var(--bg-elevated); color: var(--text-main); border: 1px solid var(--border-color); } .btn-secondary:hover { background: var(--border-hover); }
        .btn-danger { background: var(--danger-bg); color: var(--danger); } .btn-danger:hover { background: var(--danger); color: white; }
    </style>
</head>
<body>

    <div id="drop-overlay">Drop images to add</div>

    <div id="app-container">
        <div id="menu-screen">
            <h1 class="app-title">Tier<span>Maker</span></h1>
            
            <div class="menu-actions">
                <button class="btn-create" onclick="createNewList()">Create New Template</button>
                <button class="btn-data" onclick="openBackupMenu()">Data & Backup</button>
            </div>

            <div id="list-container">Loading...</div>
        </div>

        <div id="editor-screen" class="hidden">
            <div class="top-bar">
                <button class="btn-back" onclick="backToMenu()">‹ Back</button>
                <input type="text" id="list-name" class="list-name-input" placeholder="Enter title..." onchange="updateListName()">
            </div>

            <div class="capture-wrapper">
                <div id="capture-area">
                    <div id="tier-header" class="board-header-style" onclick="openHeaderModal()">Tier List</div>
                    <div id="tier-board"></div>
                </div>
            </div>
            
            <div class="board-footer-actions">
                <button class="btn-text-action" onclick="addNewTier()">Add Row</button>
                <button class="btn-text-action" onclick="toggleHeader()">Toggle Header</button>
                <button class="btn-text-action danger" onclick="resetBoard()">Reset Board</button>
            </div>

            <div id="dock-container-box" class="dock-container">
                <div class="dock-header-wrap">
                    <div class="dock-header">Library</div>
                    <button class="btn-clear-dock" onclick="clearLibrary()">Clear Library</button>
                </div>
                <div id="dock" onclick="moveToDock()"></div>
            </div>
            
            <div class="bottom-toolbar">
                <button class="btn-bottom btn-save" onclick="saveImage()">Download Image</button>
                <button class="btn-bottom btn-add" onclick="document.getElementById('imgInput').click()">Add Photos</button>
            </div>
            <input type="file" id="imgInput" multiple accept="image/*" onchange="handleFiles(event)" style="display:none">
        </div>

        <div id="resize-control" class="hidden">
            <div class="size-slider-wrap">
                <span class="size-label">Size</span>
                <button class="btn-size-adjust" onclick="adjustSize(-5)">-</button>
                <input type="range" id="size-slider" class="resize-slider" min="40" max="200" value="85" oninput="resizeSelectedImg(this.value)">
                <button class="btn-size-adjust" onclick="adjustSize(5)">+</button>
                <span id="size-val" class="size-val">85px</span>
            </div>
            <div class="control-actions">
                <button class="btn-pill btn-pill-dock" onclick="moveToDock()">↓ Library</button>
                <button class="btn-pill btn-pill-all" onclick="applyToAll()">✦ Apply All</button>
                <button class="btn-pill btn-pill-del" onclick="deleteSelected()">✕ Delete</button>
            </div>
            <button class="btn-pill-close" onclick="deselectImg()">Done</button>
        </div>
    </div>

    <div id="backup-modal-overlay" class="modal-overlay">
        <div class="modal">
            <h2>Data Management</h2>
            <p style="font-size:0.85rem; color:var(--text-muted); margin-top:-10px; margin-bottom:24px;">Backup or sync your tier lists.</p>
            
            <div style="display:flex; flex-direction:column; gap:12px;">
                <button class="btn-primary" onclick="copyData()">Copy Data Code</button>
                <button class="btn-secondary" onclick="openPasteModal()">Paste Data Code</button>
                
                <hr style="border-color:var(--border-color); width:100%; margin: 8px 0;">
                
                <button class="btn-secondary" onclick="exportData()">Export JSON File</button>
                <button class="btn-secondary" onclick="document.getElementById('importFile').click()">Import JSON File</button>
                <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
            </div>
            <button class="btn-secondary" style="margin-top:24px; width:100%; border:none; background:transparent;" onclick="closeModal('backup-modal-overlay')">Close</button>
        </div>
    </div>

    <div id="paste-modal-overlay" class="modal-overlay">
        <div class="modal">
            <h2>Paste Backup Code</h2>
            <p style="font-size:0.85rem; color:var(--text-muted); margin-top:-10px; margin-bottom:16px;">Paste the code you copied earlier.</p>
            <textarea id="paste-data-input" rows="6" placeholder="Paste data here..."></textarea>
            <div class="modal-btns">
                <button class="btn-primary" onclick="processPasteData()">Restore Data</button>
                <button class="btn-secondary" style="border:none; background:transparent" onclick="closeModal('paste-modal-overlay')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        <div class="modal">
            <h2>Edit Row</h2>
            <label>Label</label> <input type="text" id="edit-name">
            <label>Background Color</label>
            <div class="color-grid" id="bg-preset-grid"></div>
            <div class="hex-input-row">
                <span class="hex-label">HEX</span>
                <input type="text" id="edit-bg-hex" class="hex-field" oninput="syncFromHex()">
            </div>
            <input type="hidden" id="edit-color">
            <label>Text Color</label>
            <div class="color-grid" style="grid-template-columns:1fr 1fr; margin-top:8px;">
                <div class="circle" style="width:100%; border-radius:8px; background:#000; text-align:center; line-height:38px; color:#fff; font-weight:600; font-size:0.9rem;" onclick="setTextCol('#000000', 'edit-text')">Black</div>
                <div class="circle" style="width:100%; border-radius:8px; background:#fff; text-align:center; line-height:38px; color:#000; font-weight:600; font-size:0.9rem;" onclick="setTextCol('#FFFFFF', 'edit-text')">White</div>
            </div>
            <input type="hidden" id="edit-text">
            
            <div class="modal-btns">
                <button class="btn-primary" onclick="saveTierEdit()">Save Changes</button>
                <div style="display:flex; gap:10px;">
                    <button class="btn-secondary" style="flex:1;" onclick="moveTier(-1)">Move Up</button>
                    <button class="btn-secondary" style="flex:1;" onclick="moveTier(1)">Move Down</button>
                </div>
                <button class="btn-secondary" style="color: var(--warn)" onclick="clearRowImages()">Clear Images</button>
                <button class="btn-danger" onclick="deleteTier()">Delete Entire Row</button>
                <button class="btn-secondary" style="border:none; background:transparent" onclick="closeModal('modal-overlay')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="header-modal-overlay" class="modal-overlay">
        <div class="modal">
            <h2>Edit Header</h2>
            <label>Title Name</label> <input type="text" id="header-edit-name" oninput="document.getElementById('list-name').value = this.value; updateListName();">
            <label>Background Color</label>
            <div class="color-grid" id="header-bg-preset-grid"></div>
            <div class="hex-input-row">
                <span class="hex-label">HEX</span>
                <input type="text" id="header-edit-bg-hex" class="hex-field" oninput="syncHeaderHex()">
            </div>
            <input type="hidden" id="header-edit-color">
            <label>Text Color</label>
            <div class="color-grid" style="grid-template-columns:1fr 1fr; margin-top:8px;">
                <div class="circle" style="width:100%; border-radius:8px; background:#000; text-align:center; line-height:38px; color:#fff; font-weight:600; font-size:0.9rem;" onclick="setTextCol('#000000', 'header-edit-text')">Black</div>
                <div class="circle" style="width:100%; border-radius:8px; background:#fff; text-align:center; line-height:38px; color:#000; font-weight:600; font-size:0.9rem;" onclick="setTextCol('#FFFFFF', 'header-edit-text')">White</div>
            </div>
            <input type="hidden" id="header-edit-text">
            
            <div class="modal-btns">
                <button class="btn-primary" onclick="saveHeaderEdit()">Save Changes</button>
                <button class="btn-secondary" style="border:none; background:transparent" onclick="closeModal('header-modal-overlay')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const DB_NAME = 'TierMaker_V26_Pro'; 
        const PRESET_COLORS = ['#FF7F7F','#FFBF7F','#FFDF7F','#FFFF7F','#BFFF7F','#7FFF7F','#7FFFFF','#7FBFFF','#7F7FFF','#FF7FBF','#D27FFF','#18181b','#808080','#e4e4e7','#FFFFFF'];
        
        let db, currentListData, selectedImgObj = null, editingTierIndex = -1;
        let draggedItem = null, draggedRowIdx = null;

        window.onload = () => {
            const req = indexedDB.open(DB_NAME, 1);
            req.onupgradeneeded = e => e.target.result.createObjectStore('lists', {keyPath:'id'});
            req.onsuccess = e => { db=e.target.result; loadMenu(); initDockDrop(); initGlobalFileDrop(); };
        };

        // --- GLOBAL FILE DROP ---
        function initGlobalFileDrop() {
            const overlay = document.getElementById('drop-overlay');
            window.addEventListener('dragover', e => {
                if (draggedItem) return; 
                if(e.dataTransfer.types.includes("Files") && !document.getElementById('editor-screen').classList.contains('hidden')) {
                    e.preventDefault(); overlay.style.display = 'flex';
                }
            });
            window.addEventListener('dragleave', e => { if(e.target === overlay) overlay.style.display = 'none'; });
            window.addEventListener('drop', e => {
                overlay.style.display = 'none';
                if (draggedItem) return;
                if(e.dataTransfer.files && e.dataTransfer.files.length > 0 && !document.getElementById('editor-screen').classList.contains('hidden')) {
                    e.preventDefault(); handleFiles({target: {files: e.dataTransfer.files}});
                }
            });
        }

        // --- DATA BACKUP ---
        function openBackupMenu() { document.getElementById('backup-modal-overlay').style.display = 'flex'; }
        function copyData() {
            db.transaction(['lists']).objectStore('lists').getAll().onsuccess = e => {
                const data = e.target.result;
                if(data.length === 0) return alert("Không có dữ liệu.");
                navigator.clipboard.writeText(JSON.stringify(data)).then(() => {
                    closeModal('backup-modal-overlay');
                    alert("✅ Đã copy mã dữ liệu!");
                }).catch(() => alert("❌ Lỗi copy."));
            };
        }
        function openPasteModal() { closeModal('backup-modal-overlay'); document.getElementById('paste-data-input').value = ''; document.getElementById('paste-modal-overlay').style.display = 'flex'; }
        function processPasteData() {
            const str = document.getElementById('paste-data-input').value;
            if(!str) return alert("Vui lòng dán mã.");
            try {
                const dataArr = JSON.parse(str);
                if(!Array.isArray(dataArr)) throw new Error();
                if(!confirm("Ghi đè dữ liệu cũ?")) return;
                const tx = db.transaction(['lists'], 'readwrite');
                dataArr.forEach(item => tx.objectStore('lists').put(item));
                tx.oncomplete = () => { closeModal('paste-modal-overlay'); loadMenu(); };
            } catch(e) { alert("❌ Mã không hợp lệ."); }
        }
        function exportData() {
            db.transaction(['lists']).objectStore('lists').getAll().onsuccess = e => {
                const data = e.target.result;
                if(data.length === 0) return;
                const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data)); a.download = "TierMaker.json"; document.body.appendChild(a); a.click(); a.remove();
            };
        }
        function importData(e) {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    const dataArr = JSON.parse(ev.target.result);
                    if(!confirm("Ghi đè dữ liệu cũ?")) return;
                    const tx = db.transaction(['lists'], 'readwrite');
                    dataArr.forEach(item => tx.objectStore('lists').put(item));
                    tx.oncomplete = () => { loadMenu(); closeModal('backup-modal-overlay'); };
                } catch(err) { alert("File lỗi."); }
            };
            reader.readAsText(file); e.target.value = '';
        }

        // --- MENU ---
        function loadMenu() {
            db.transaction(['lists']).objectStore('lists').getAll().onsuccess = e => {
                const list = e.target.result.sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                const container = document.getElementById('list-container');
                if (!list.length) { container.innerHTML = '<p style="text-align:center;color:var(--text-muted);grid-column:1/-1;margin-top:20px;">No templates found.</p>'; return; }
                container.innerHTML = list.map(l => {
                    const thumbHTML = l.thumbnail ? `<img src="${l.thumbnail}" class="list-thumb">` : `<div class="list-placeholder">No Preview</div>`;
                    return `
                    <div class="list-item" onclick="openList('${l.id}')">
                        ${thumbHTML}
                        <div class="list-info-wrap">
                            <div class="list-info"><h3>${l.name}</h3><p>${new Date(l.updatedAt).toLocaleDateString()}</p></div>
                            <button class="btn-del-list" onclick="event.stopPropagation(); deleteList('${l.id}')">✕</button>
                        </div>
                    </div>`
                }).join('');
            };
        }

        async function backToMenu() {
            deselectImg();
            const captureArea = document.getElementById('capture-area');
            captureArea.classList.add('is-exporting');
            try {
                const canvas = await html2canvas(captureArea, { scale: 0.3, backgroundColor: '#000', useCORS: true });
                currentListData.thumbnail = canvas.toDataURL('image/jpeg', 0.5); 
            } catch (err) {}
            captureArea.classList.remove('is-exporting');
            saveList(currentListData, () => {
                document.getElementById('editor-screen').classList.add('hidden');
                document.getElementById('menu-screen').classList.remove('hidden');
                loadMenu(); 
            });
        }

        function createNewList() {
            const name = prompt("Template Name:", "New Tier List"); if(!name) return;
            const newList = { 
                id: 'list_' + Date.now(), name: name, updatedAt: new Date().toISOString(), 
                header: { bg: '#000000', text: '#ffffff', visible: true },
                tiers: [{name:'S', color:'#FF7F7F', text:'#000', items:[]}, {name:'A', color:'#FFBF7F', text:'#000', items:[]}, {name:'B', color:'#FFDF7F', text:'#000', items:[]}, {name:'C', color:'#FFFF7F', text:'#000', items:[]}], 
                dock:[], thumbnail: null 
            };
            saveList(newList, () => openList(newList.id)); 
        }

        function openList(id) {
            db.transaction(['lists']).objectStore('lists').get(id).onsuccess = e => {
                currentListData = e.target.result;
                if(!currentListData.header) currentListData.header = { bg: '#000000', text: '#ffffff', visible: true }; 
                document.getElementById('menu-screen').classList.add('hidden');
                document.getElementById('editor-screen').classList.remove('hidden');
                document.getElementById('list-name').value = currentListData.name;
                renderBoard(); window.scrollTo(0,0);
            };
        }

        // --- BOARD ACTIONS ---
        function resetBoard() {
            if(!confirm("Reset toàn bộ bảng?")) return;
            currentListData.tiers.forEach(t => { currentListData.dock.push(...t.items); t.items = []; });
            saveAndRefresh();
        }

        function clearLibrary() {
            if(currentListData.dock.length === 0) return;
            if(!confirm("Xóa sạch kho ảnh?")) return;
            currentListData.dock = []; saveAndRefresh();
        }

        function toggleHeader() { currentListData.header.visible = !currentListData.header.visible; saveAndRefresh(); }

        function initDockDrop() {
            const dockContainer = document.getElementById('dock-container-box');
            dockContainer.ondragover = e => { if(draggedItem) { e.preventDefault(); dockContainer.classList.add('drag-over'); } };
            dockContainer.ondragleave = e => { dockContainer.classList.remove('drag-over'); };
            dockContainer.ondrop = e => {
                e.preventDefault(); dockContainer.classList.remove('drag-over');
                if (draggedItem && draggedItem.type !== 'dock') insertItem(draggedItem, {type: 'dock', r: null, i: currentListData.dock.length}, false);
            };
        }

        function renderBoard() {
            const board = document.getElementById('tier-board'); board.innerHTML = '';
            
            const headerEl = document.getElementById('tier-header');
            headerEl.innerText = currentListData.name || "TIER LIST";
            if (currentListData.header.visible) {
                headerEl.style.display = 'block'; headerEl.style.background = currentListData.header.bg; headerEl.style.color = currentListData.header.text;
            } else headerEl.style.display = 'none';

            currentListData.tiers.forEach((t, i) => {
                const row = document.createElement('div'); row.className = 'tier-row';
                row.draggable = true;
                row.ondragstart = e => { if(e.target.tagName !== 'IMG') { draggedRowIdx = i; row.classList.add('dragging'); e.dataTransfer.effectAllowed = "move"; } else { e.preventDefault(); } };
                row.ondragend = e => { row.classList.remove('dragging'); draggedRowIdx = null; };
                row.ondragover = e => { if(draggedRowIdx !== null) e.preventDefault(); };
                row.ondrop = e => {
                    if (draggedRowIdx !== null && draggedRowIdx !== i) {
                        e.preventDefault(); e.stopPropagation();
                        const tmp = currentListData.tiers.splice(draggedRowIdx, 1)[0];
                        currentListData.tiers.splice(i, 0, tmp); saveAndRefresh();
                    }
                };

                const label = document.createElement('div'); label.className = 'tier-label'; label.style.background = t.color; label.style.color = t.text||'#000'; label.innerText = t.name; label.onclick = () => openEditModal(i);
                const content = document.createElement('div'); content.className = 'tier-content'; 
                content.onclick = e => { if(e.target === content) moveToTier(i); };
                content.ondragover = e => { if(draggedItem) { e.preventDefault(); content.classList.add('drag-over'); } };
                content.ondragleave = e => { content.classList.remove('drag-over'); };
                content.ondrop = e => {
                    e.preventDefault(); content.classList.remove('drag-over');
                    if (draggedItem && e.target === content) insertItem(draggedItem, {type: 'tier', r: i, i: currentListData.tiers[i].items.length}, false); 
                };

                t.items.forEach((item, idx) => content.appendChild(createImg(item, 'tier', i, idx)));
                row.appendChild(label); row.appendChild(content); board.appendChild(row);
            });
            const dock = document.getElementById('dock'); dock.innerHTML = '';
            currentListData.dock.forEach((item, idx) => dock.appendChild(createImg(item, 'dock', null, idx)));
        }

        function insertItem(src, tgt, after) {
            if (src.type === tgt.type && src.r === tgt.r && src.i === tgt.i) return;
            let itemData = src.data;
            if (src.type === 'tier') currentListData.tiers[src.r].items.splice(src.i, 1);
            else currentListData.dock.splice(src.i, 1);
            let targetIdx = tgt.i;
            if (src.type === tgt.type && src.r === tgt.r && src.i < tgt.i) targetIdx--;
            if (after) targetIdx++;
            if (tgt.type === 'tier') currentListData.tiers[tgt.r].items.splice(targetIdx, 0, itemData);
            else currentListData.dock.splice(targetIdx, 0, itemData);
            saveAndRefresh();
        }

        function createImg(data, type, r, i) {
            const img = document.createElement('img');
            const src = typeof data === 'object' ? data.src : data; 
            const h = (typeof data === 'object' && data.h) ? data.h : 85;
            img.src = src; img.className = 'img-item'; 
            if(type === 'tier') img.style.height = h + 'px';
            
            img.onclick = e => { e.stopPropagation(); clickImg(img, data, type, r, i); };
            img.draggable = true;
            img.ondragstart = e => { draggedItem = { data, type, r, i }; e.dataTransfer.effectAllowed = "move"; e.stopPropagation(); setTimeout(() => img.style.opacity = '0.4', 0); };
            img.ondragend = e => { img.style.opacity = '1'; draggedItem = null; };
            img.ondragover = e => { 
                if(draggedItem) {
                    e.preventDefault(); const rect = img.getBoundingClientRect();
                    if(e.clientX - rect.left < rect.width / 2) img.style.boxShadow = '-4px 0 0 var(--primary)';
                    else img.style.boxShadow = '4px 0 0 var(--primary)';
                }
            };
            img.ondragleave = e => { img.style.boxShadow = ''; };
            img.ondrop = e => {
                if (draggedItem) {
                    e.preventDefault(); e.stopPropagation(); img.style.boxShadow = '';
                    const rect = img.getBoundingClientRect();
                    const insertAfter = (e.clientX - rect.left) > (rect.width / 2);
                    insertItem(draggedItem, { data, type, r, i }, insertAfter);
                }
            };
            return img;
        }

        function clickImg(dom, data, type, r, i) { if(!selectedImgObj) { selectedImgObj = { dom, data, type, r, i }; dom.classList.add('selected'); document.getElementById('resize-control').classList.remove('hidden'); const h = (typeof data === 'object' && data.h) ? data.h : 85; document.getElementById('size-slider').value = h; document.getElementById('size-val').innerText = h+'px'; } else if(selectedImgObj.dom === dom) { deselectImg(); } else { swapItems(selectedImgObj, { data, type, r, i }); } }
        function swapItems(a, b) { const itemA = getItem(a); const itemB = getItem(b); setItem(a, itemB); setItem(b, itemA); saveList(currentListData, () => { renderBoard(); deselectImg(); draggedItem = null; }); }
        function getItem(o) { return o.type==='tier' ? currentListData.tiers[o.r].items[o.i] : currentListData.dock[o.i]; }
        function setItem(o, val) { if(o.type==='tier') currentListData.tiers[o.r].items[o.i]=val; else currentListData.dock[o.i]=val; }
        function deselectImg() { if(selectedImgObj) selectedImgObj.dom.classList.remove('selected'); selectedImgObj = null; document.getElementById('resize-control').classList.add('hidden'); }
        
        function resizeSelectedImg(h) { if(!selectedImgObj) return; h = parseInt(h); selectedImgObj.dom.style.height = h+'px'; selectedImgObj.dom.style.width = 'auto'; document.getElementById('size-val').innerText = h+'px'; const src = typeof selectedImgObj.data === 'object' ? selectedImgObj.data.src : selectedImgObj.data; const newItem = { src, h }; setItem(selectedImgObj, newItem); selectedImgObj.data = newItem; }
        function adjustSize(d) { if(!selectedImgObj) return; let v = parseInt(document.getElementById('size-slider').value) + d; if(v<40)v=40; if(v>200)v=200; document.getElementById('size-slider').value = v; resizeSelectedImg(v); }
        function applyToAll() { if(!selectedImgObj) return; const h = (typeof selectedImgObj.data === 'object' && selectedImgObj.data.h) ? selectedImgObj.data.h : 85; if(!confirm('Apply size '+h+'px to all images?')) return; const fix = i => ({ src: (typeof i==='object'?i.src:i), h }); currentListData.tiers.forEach(t => t.items = t.items.map(fix)); currentListData.dock = currentListData.dock.map(fix); saveList(currentListData, () => { renderBoard(); deselectImg(); }); }
        function moveToDock() { if(!selectedImgObj) return; if(selectedImgObj.type === 'dock') { deselectImg(); return; } removeItem(selectedImgObj); currentListData.dock.push(selectedImgObj.data); saveAndRefresh(); }
        function moveToTier(r) { if(!selectedImgObj) return; removeItem(selectedImgObj); currentListData.tiers[r].items.push(selectedImgObj.data); saveAndRefresh(); }
        function deleteSelected() { if(!selectedImgObj) return; removeItem(selectedImgObj); saveAndRefresh(); }
        function removeItem(o) { if(o.type==='tier') currentListData.tiers[o.r].items.splice(o.i, 1); else currentListData.dock.splice(o.i, 1); }
        function saveAndRefresh() { saveList(currentListData, () => { renderBoard(); deselectImg(); draggedItem = null; draggedRowIdx = null; }); }

        // --- MODALS ---
        function openEditModal(i) { editingTierIndex = i; const t = currentListData.tiers[i]; document.getElementById('edit-name').value = t.name; document.getElementById('edit-text').value = t.text || '#000'; renderPresets('bg-preset-grid', 'edit-bg-hex'); const currentColor = t.color; document.getElementById('edit-bg-hex').value = currentColor; const circles = document.querySelectorAll('#bg-preset-grid .circle'); PRESET_COLORS.forEach((c, idx) => { if(c.toLowerCase() === currentColor.toLowerCase()) { if(circles[idx]) circles[idx].classList.add('selected'); } }); document.getElementById('modal-overlay').style.display = 'flex'; }
        function renderPresets(containerId, hexInputId) { const grid = document.getElementById(containerId); grid.innerHTML = ''; PRESET_COLORS.forEach(color => { const div = document.createElement('div'); div.className = 'circle'; div.style.backgroundColor = color; div.onclick = () => { document.querySelectorAll(`#${containerId} .circle`).forEach(c => c.classList.remove('selected')); div.classList.add('selected'); document.getElementById(hexInputId).value = color; }; grid.appendChild(div); }); }
        function syncFromHex() { document.querySelectorAll('#bg-preset-grid .circle').forEach(x => x.classList.remove('selected')); document.getElementById('edit-color').value = document.getElementById('edit-bg-hex').value; }
        function setTextCol(c, inputId) { document.getElementById(inputId).value = c; }
        function saveTierEdit() { const t = currentListData.tiers[editingTierIndex]; t.name = document.getElementById('edit-name').value; t.color = document.getElementById('edit-bg-hex').value; t.text = document.getElementById('edit-text').value; closeModal('modal-overlay'); saveList(currentListData, renderBoard); }
        function addNewTier() { currentListData.tiers.push({name:'NEW',color:'#18181b',text:'#fff',items:[]}); saveList(currentListData, renderBoard); }
        function deleteTier() { if(confirm('Xóa hẳn hàng này?')) { currentListData.dock.push(...currentListData.tiers[editingTierIndex].items); currentListData.tiers.splice(editingTierIndex,1); closeModal('modal-overlay'); saveList(currentListData, renderBoard); } }
        function clearRowImages() { if(currentListData.tiers[editingTierIndex].items.length === 0) { closeModal('modal-overlay'); return; } if(!confirm('Đưa ảnh về kho?')) return; currentListData.dock.push(...currentListData.tiers[editingTierIndex].items); currentListData.tiers[editingTierIndex].items = []; closeModal('modal-overlay'); saveList(currentListData, renderBoard); }
        function moveTier(d) { const n = editingTierIndex+d; if(n>=0 && n<currentListData.tiers.length) { [currentListData.tiers[editingTierIndex], currentListData.tiers[n]] = [currentListData.tiers[n], currentListData.tiers[editingTierIndex]]; editingTierIndex = n; saveList(currentListData, renderBoard); } }

        function openHeaderModal() { document.getElementById('header-edit-name').value = currentListData.name; document.getElementById('header-edit-text').value = currentListData.header.text; renderPresets('header-bg-preset-grid', 'header-edit-bg-hex'); document.getElementById('header-edit-bg-hex').value = currentListData.header.bg; document.getElementById('header-modal-overlay').style.display = 'flex'; }
        function syncHeaderHex() { document.querySelectorAll('#header-bg-preset-grid .circle').forEach(x => x.classList.remove('selected')); }
        function saveHeaderEdit() { currentListData.name = document.getElementById('header-edit-name').value; currentListData.header.bg = document.getElementById('header-edit-bg-hex').value; currentListData.header.text = document.getElementById('header-edit-text').value; closeModal('header-modal-overlay'); saveList(currentListData, () => { updateListName(); renderBoard(); }); }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function handleFiles(e) {
            if(!e.target.files.length)return; let l=0;
            Array.from(e.target.files).forEach(f=>{
                if(!f.type.startsWith('image/')) { l++; return; }
                const r=new FileReader(); r.onload=ev=>{
                    const i=new Image(); i.src=ev.target.result; i.onload=()=>{
                        const c=document.createElement('canvas'), x=c.getContext('2d'), M=600; let w=i.width, h=i.height; if(w>M){h*=(M/w);w=M;} c.width=w; c.height=h; x.drawImage(i,0,0,w,h);
                        currentListData.dock.push({src:c.toDataURL('image/jpeg',0.8), h:85}); l++; if(l===e.target.files.length) saveList(currentListData, renderBoard);
                    }
                }; r.readAsDataURL(f);
            });
        }

        function saveList(data, cb) { data.updatedAt = new Date().toISOString(); const tx = db.transaction(['lists'], 'readwrite'); tx.objectStore('lists').put(data); tx.oncomplete = () => { if(cb) cb(); }; }
        function deleteList(id) { if(confirm('Delete template?')) { const tx = db.transaction(['lists'],'readwrite'); tx.objectStore('lists').delete(id); tx.oncomplete = loadMenu; } }
        function updateListName() { currentListData.name = document.getElementById('list-name').value; document.getElementById('tier-header').innerText = currentListData.name; saveList(currentListData); }
        
        function saveImage() { 
            deselectImg(); window.scrollTo(0,0); 
            document.body.style.overflow = 'hidden'; 
            const captureWrapper = document.querySelector('.capture-wrapper');
            captureWrapper.classList.add('is-exporting'); 
            html2canvas(captureWrapper, {
                scale: 2, backgroundColor: '#09090b', useCORS: true
            }).then(c => { 
                captureWrapper.classList.remove('is-exporting'); document.body.style.overflow = ''; 
                const a = document.createElement('a'); a.download = currentListData.name + '.png'; a.href = c.toDataURL(); a.click(); 
            }); 
        }
    </script>
</body>
</html>
