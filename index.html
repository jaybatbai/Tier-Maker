<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#141414">
    
    <title>Tier List Maker V21</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* GLOBAL */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: #0a0a0a; color: #fff; margin: 0; padding: 0; 
            padding-bottom: 80px; overscroll-behavior: none;
        }
        .hidden { display: none !important; }

        /* MENU */
        #menu-screen { padding: 40px 20px; max-width: 600px; margin: 0 auto; min-height: 100vh; }
        .app-title { text-align: center; color: #4CAF50; font-size: 2.2rem; margin-bottom: 40px; font-weight: 900; letter-spacing: 2px; }
        .btn-create { width: 100%; padding: 20px; background: #4CAF50; color: white; font-weight: bold; border: none; border-radius: 12px; margin-bottom: 20px; font-size: 1.2rem; box-shadow: 0 5px 15px rgba(76,175,80,0.3); }
        .list-item { background: #1c1c1c; padding: 20px; margin-bottom: 12px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #4CAF50; }
        .list-info h3 { margin: 0; font-size: 1.1rem; } .list-info p { margin: 5px 0 0; font-size: 0.8rem; color: #888; }
        .btn-del-list { background: rgba(255,255,255,0.05); border: none; color: #f44336; padding: 12px 16px; border-radius: 8px; font-size: 1.2rem; }

        /* EDITOR */
        #editor-screen { min-height: 100vh; display: flex; flex-direction: column; }
        .top-bar { 
            background: #141414; padding: 15px; display: flex; gap: 15px; align-items: center; 
            position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #2a2a2a;
        }
        .btn-back { background: transparent; color: #aaa; border: none; font-size: 1.8rem; padding: 0 10px; }
        .list-name-input { flex: 1; background: transparent; border: none; color: white; font-size: 1.3rem; font-weight: bold; }

        /* BOARD AREA */
        #capture-area { background: #000; display: flex; flex-direction: column; }
        .board-header-style {
            text-align: center; font-size: 28px; font-weight: 900; padding: 25px 10px; 
            background: #111; color: #fff; text-transform: uppercase; letter-spacing: 2px; 
            font-family: "Impact", sans-serif; border-bottom: 3px solid #333;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5); width: 100%;
        }
        .btn-add-row { color: #666; border: none; cursor: pointer; transition: 0.2s; }
        .btn-add-row:active { background: #222; color: #888; }

        .tier-row { display: flex; min-height: 85px; background: #000; margin-bottom: 1px; border-top: 1px solid #000; }
        .tier-label { width: 90px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; color: #000; text-align: center; border-right: 2px solid #000; padding: 5px; word-break: break-word; }
        .tier-content { flex: 1; display: flex; flex-wrap: wrap; align-items: flex-start; background: #1a1a1a; padding: 0; gap: 0; align-content: flex-start; }

        /* IMAGE */
        .img-item { width: auto; height: 100px; display: block; transition: 0.1s; cursor: pointer; }
        .img-item.selected { outline: 4px solid #4CAF50; outline-offset: -4px; z-index: 10; filter: brightness(1.2); }

        /* DOCK (CƒÇN TR√ÅI) */
        .dock-container { background: #141414; border-top: 3px solid #333; padding: 15px 10px; min-height: 200px; margin-top: auto; }
        .dock-header { text-align: left; font-size: 0.9rem; color: #666; margin-bottom: 10px; font-weight: bold; padding-left: 5px; }
        #dock { 
            display: flex; flex-wrap: wrap; gap: 5px; 
            justify-content: flex-start; /* CƒÉn tr√°i */
            align-content: flex-start; padding-bottom: 80px; 
        }
        #dock .img-item { height: 75px !important; border-radius: 6px; border: 2px solid #333; }

        /* BOTTOM BAR */
        .bottom-toolbar {
            position: fixed; bottom: 0; left: 0; right: 0; background: #1c1c1c; 
            padding: 12px 20px; display: flex; gap: 15px; border-top: 1px solid #333; z-index: 200;
        }
        .btn-bottom { flex: 1; padding: 14px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-save { background: #2196F3; } .btn-add { background: #4CAF50; }

        /* CONTROLS */
        #resize-control {
            position: fixed; bottom: 80px; left: 0; right: 0; background: rgba(28,28,28,0.95); backdrop-filter: blur(10px);
            border-top: 1px solid #444; z-index: 250; padding: 10px 15px; display: flex; flex-direction: column;
        }
        .ctrl-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; width: 100%; gap: 10px; }
        .btn-tool { background: #444; border: none; color: white; padding: 12px; border-radius: 8px; font-weight: bold; min-width: 50px; }
        .resize-slider { flex: 1; height: 6px; border-radius: 3px; background: #555; outline: none; }

        /* MODAL */
        #modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 300; display: none; align-items: center; justify-content: center; }
        .modal { background: #252525; padding: 25px; border-radius: 16px; width: 90%; max-width: 340px; max-height: 85vh; overflow-y: auto; }
        .modal input[type="text"] { width: 100%; padding: 12px; margin: 5px 0 0; border-radius: 8px; border: 2px solid #444; background: #333; color: white; font-size: 1rem; }
        
        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin: 15px 0; justify-items: center; }
        .circle { width: 40px; height: 40px; border-radius: 50%; border: 3px solid #444; cursor: pointer; transition: transform 0.1s; }
        .circle.selected { border-color: white; transform: scale(1.15); box-shadow: 0 0 10px white; }
        
        /* Hex Input Row */
        .hex-input-row { display: flex; align-items: center; background: #333; padding: 5px 10px; border-radius: 8px; margin-top: 10px; border: 2px solid #444; }
        .hex-label { color: #aaa; font-family: monospace; margin-right: 10px; }
        .hex-field { flex: 1; background: transparent; border: none; color: white; font-family: monospace; font-size: 1.1rem; text-transform: uppercase; }

        .modal-btns button { width: 100%; padding: 14px; margin-top: 10px; border: none; border-radius: 10px; font-weight: bold; color: white; font-size: 1rem; }
    </style>
</head>
<body>

    <div id="menu-screen">
        <h1 class="app-title">TIER LIST MAKER</h1>
        <button class="btn-create" onclick="createNewList()">+ NEW TEMPLATE</button>
        <div id="list-container">Loading...</div>
    </div>

    <div id="editor-screen" class="hidden">
        <div class="top-bar">
            <button class="btn-back" onclick="backToMenu()">‚¨Ö</button>
            <input type="text" id="list-name" class="list-name-input" onchange="updateListName()">
        </div>

        <div id="capture-area">
            <div id="tier-header" class="board-header-style">MY TIER LIST</div>
            <div id="tier-board"></div>
        </div>
        
        <button class="board-header-style btn-add-row" onclick="addNewTier()">+ ADD ROW</button>

        <div class="dock-container">
            <div class="dock-header">IMAGE LIBRARY</div>
            <div id="dock" onclick="moveToDock()"></div>
        </div>
        
        <div class="bottom-toolbar">
            <button class="btn-bottom btn-save" onclick="saveImage()">üì∑ SAVE</button>
            <button class="btn-bottom btn-add" onclick="document.getElementById('imgInput').click()">‚ûï PHOTOS</button>
        </div>
        <input type="file" id="imgInput" multiple accept="image/*" onchange="handleFiles(event)" style="display:none">
    </div>

    <div id="resize-control" class="hidden">
        <div class="ctrl-row">
            <button class="btn-tool" onclick="adjustSize(-5)">‚ûñ</button>
            <input type="range" id="size-slider" class="resize-slider" min="50" max="300" value="100" oninput="resizeSelectedImg(this.value)">
            <button class="btn-tool" onclick="adjustSize(5)">‚ûï</button>
            <span id="size-val" style="width:60px; text-align:center; font-weight:bold;">H:100</span>
        </div>
        <div class="ctrl-row">
            <button class="btn-tool" style="background:#d32f2f; flex:1" onclick="deleteSelected()">üóëÔ∏è DELETE</button>
            <button class="btn-tool" style="background:#2196F3; flex:2" onclick="applyToAll()">‚ö° SET ALL</button>
            <button class="btn-tool" style="background:#555; flex:1" onclick="deselectImg()">OK</button>
        </div>
    </div>

    <div id="modal-overlay">
        <div class="modal">
            <h2 style="text-align:center; margin-top:0; color:#4CAF50">Edit Tier</h2>
            <label>Name</label> <input type="text" id="edit-name">
            
            <label style="margin-top:15px">Background Color</label>
            <div class="color-grid" id="bg-preset-grid"></div>
            
            <div class="hex-input-row">
                <span class="hex-label">HEX:</span>
                <input type="text" id="edit-bg-hex" class="hex-field" placeholder="#FFFFFF" oninput="syncFromHex()">
            </div>
            <input type="hidden" id="edit-color">

            <label style="margin-top:15px">Text Color</label>
            <div class="color-grid" style="grid-template-columns:1fr 1fr; margin:10px 0 0 0;">
                <div class="circle" style="width:100%; border-radius:8px; background:#000; text-align:center; line-height:40px; color:#fff; font-weight:bold;" onclick="setTextCol('#000000')">Black</div>
                <div class="circle" style="width:100%; border-radius:8px; background:#fff; text-align:center; line-height:40px; color:#000; font-weight:bold;" onclick="setTextCol('#FFFFFF')">White</div>
            </div>
            <input type="hidden" id="edit-text">

            <div class="modal-btns">
                <button style="background:#4CAF50" onclick="saveTierEdit()">Save</button>
                <div style="display:flex; gap:10px; margin-top:10px">
                    <button style="background:#2196F3; flex:1; margin:0" onclick="moveTier(-1)">‚¨ÜÔ∏è</button>
                    <button style="background:#2196F3; flex:1; margin:0" onclick="moveTier(1)">‚¨áÔ∏è</button>
                </div>
                <button style="background:#d32f2f" onclick="deleteTier()">Delete</button>
                <button style="background:#444" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const DB_NAME = 'TierMaker_V21_Final';
        const PRESET_COLORS = ['#FF7F7F','#FFBF7F','#FFDF7F','#FFFF7F','#BFFF7F','#7FFF7F','#7FFFFF','#7FBFFF','#7F7FFF','#FF7FBF','#D27FFF','#333333','#808080','#C0C0C0','#FFFFFF'];
        let db, currentListData, selectedImgObj = null, editingTierIndex = -1;

        window.onload = () => {
            const req = indexedDB.open(DB_NAME, 1);
            req.onupgradeneeded = e => e.target.result.createObjectStore('lists', {keyPath:'id'});
            req.onsuccess = e => { db=e.target.result; loadMenu(); };
        };

        function loadMenu() {
            db.transaction(['lists']).objectStore('lists').getAll().onsuccess = e => {
                const list = e.target.result.sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                document.getElementById('list-container').innerHTML = list.length ? list.map(l => `
                    <div class="list-item">
                        <div class="list-info" onclick="openL('${l.id}')"><h3>${l.name}</h3><p>${new Date(l.updatedAt).toLocaleDateString()}</p></div>
                        <button class="btn-del-list" onclick="deleteList('${l.id}')">‚úñ</button>
                    </div>`).join('') : '<p style="text-align:center;color:#666;margin-top:20px">No lists yet.</p>';
            };
        }

        function createNewList() {
            const name = prompt("Enter Name:", "New Tier List"); if(!name) return;
            const newList = { id: 'list_' + Date.now(), name: name, updatedAt: new Date().toISOString(), tiers: [{name:'S', color:'#FF7F7F', text:'#000', items:[]}, {name:'A', color:'#FFBF7F', text:'#000', items:[]}, {name:'B', color:'#FFDF7F', text:'#000', items:[]}], dock:[] };
            saveList(newList, () => openList(newList.id)); 
        }

        function openList(id) {
            db.transaction(['lists']).objectStore('lists').get(id).onsuccess = e => {
                currentListData = e.target.result;
                document.getElementById('menu-screen').classList.add('hidden');
                document.getElementById('editor-screen').classList.remove('hidden');
                document.getElementById('list-name').value = currentListData.name;
                document.getElementById('tier-header').innerText = currentListData.name;
                renderBoard();
            };
        }

        function backToMenu() {
            deselectImg(); document.getElementById('editor-screen').classList.add('hidden'); document.getElementById('menu-screen').classList.remove('hidden'); loadMenu();
        }

        function renderBoard() {
            const board = document.getElementById('tier-board'); board.innerHTML = '';
            currentListData.tiers.forEach((t, i) => {
                const row = document.createElement('div'); row.className = 'tier-row';
                const label = document.createElement('div'); label.className = 'tier-label'; label.style.background = t.color; label.style.color = t.text||'#000'; label.innerText = t.name; label.onclick = () => openEditModal(i);
                const content = document.createElement('div'); content.className = 'tier-content'; content.onclick = e => { if(e.target === content) moveToTier(i); };
                t.items.forEach((item, idx) => content.appendChild(createImg(item, 'tier', i, idx)));
                row.appendChild(label); row.appendChild(content); board.appendChild(row);
            });
            const dock = document.getElementById('dock'); dock.innerHTML = '';
            currentListData.dock.forEach((item, idx) => dock.appendChild(createImg(item, 'dock', null, idx)));
        }

        function createImg(data, type, r, i) {
            const img = document.createElement('img');
            const src = typeof data === 'object' ? data.src : data; const h = (typeof data === 'object' && data.h) ? data.h : 100;
            img.src = src; img.className = 'img-item'; if(type === 'tier') img.style.height = h + 'px';
            img.onclick = e => { e.stopPropagation(); clickImg(img, data, type, r, i); };
            return img;
        }

        function clickImg(dom, data, type, r, i) {
            if(!selectedImgObj) {
                selectedImgObj = { dom, data, type, r, i }; dom.classList.add('selected');
                document.getElementById('resize-control').classList.remove('hidden'); document.getElementById('resize-control').classList.add('show');
                const h = (typeof data === 'object' && data.h) ? data.h : 100; document.getElementById('size-slider').value = h; document.getElementById('size-val').innerText = 'H:'+h;
            } else if(selectedImgObj.dom === dom) { deselectImg(); } else { swapItems(selectedImgObj, { data, type, r, i }); }
        }

        function swapItems(a, b) {
            const itemA = getItem(a); const itemB = getItem(b); setItem(a, itemB); setItem(b, itemA);
            saveList(currentListData, () => { renderBoard(); deselectImg(); });
        }
        function getItem(o) { return o.type==='tier' ? currentListData.tiers[o.r].items[o.i] : currentListData.dock[o.i]; }
        function setItem(o, val) { if(o.type==='tier') currentListData.tiers[o.r].items[o.i]=val; else currentListData.dock[o.i]=val; }

        function deselectImg() {
            if(selectedImgObj) selectedImgObj.dom.classList.remove('selected');
            selectedImgObj = null; document.getElementById('resize-control').classList.add('hidden'); document.getElementById('resize-control').classList.remove('show');
        }

        function resizeSelectedImg(h) {
            if(!selectedImgObj) return; h = parseInt(h); selectedImgObj.dom.style.height = h+'px'; document.getElementById('size-val').innerText = 'H:'+h;
            const src = typeof selectedImgObj.data === 'object' ? selectedImgObj.data.src : selectedImgObj.data;
            const newItem = { src, h }; setItem(selectedImgObj, newItem); selectedImgObj.data = newItem;
        }
        function adjustSize(d) {
            if(!selectedImgObj) return; let v = parseInt(document.getElementById('size-slider').value) + d; if(v<50)v=50; if(v>300)v=300;
            document.getElementById('size-slider').value = v; resizeSelectedImg(v);
        }
        function applyToAll() {
            if(!selectedImgObj) return; const h = (typeof selectedImgObj.data === 'object' && selectedImgObj.data.h) ? selectedImgObj.data.h : 100;
            if(!confirm('Set ALL images to Height '+h+'?')) return;
            const fix = i => ({ src: (typeof i==='object'?i.src:i), h });
            currentListData.tiers.forEach(t => t.items = t.items.map(fix)); currentListData.dock = currentListData.dock.map(fix);
            saveList(currentListData, () => { renderBoard(); deselectImg(); });
        }

        function moveToTier(r) { if(!selectedImgObj) return; removeItem(selectedImgObj); currentListData.tiers[r].items.push(selectedImgObj.data); saveAndRefresh(); }
        function moveToDock() { if(!selectedImgObj) return; removeItem(selectedImgObj); currentListData.dock.push(selectedImgObj.data); saveAndRefresh(); }
        function deleteSelected() { if(!selectedImgObj) return; removeItem(selectedImgObj); saveAndRefresh(); }
        function removeItem(o) { if(o.type==='tier') currentListData.tiers[o.r].items.splice(o.i, 1); else currentListData.dock.splice(o.i, 1); }
        function saveAndRefresh() { saveList(currentListData, () => { renderBoard(); deselectImg(); }); }

        function openEditModal(i) {
            editingTierIndex = i; const t = currentListData.tiers[i]; document.getElementById('edit-name').value = t.name; document.getElementById('edit-text').value = t.text || '#000';
            document.getElementById('bg-preset-grid').innerHTML = PRESETS.map(c => `<div class="circle" style="background:${c}" onclick="pickColor('${c}', this)"></div>`).join('');
            pickColor(t.color, null); document.getElementById('modal-overlay').style.display = 'flex';
        }
        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

        function pickColor(c, el) {
            document.getElementById('edit-color').value = c; document.getElementById('edit-bg-hex').value = c;
            if(el) { document.querySelectorAll('.circle').forEach(x => x.classList.remove('selected')); el.classList.add('selected'); }
        }
        function syncFromHex() {
            document.querySelectorAll('.circle').forEach(x => x.classList.remove('selected'));
            document.getElementById('edit-color').value = document.getElementById('edit-bg-hex').value;
        }
        function setTextCol(c) { document.getElementById('edit-text').value = c; }
        function saveTierEdit() { const t = currentListData.tiers[editingTierIndex]; t.name = document.getElementById('edit-name').value; t.color = document.getElementById('edit-bg-hex').value; t.text = document.getElementById('edit-text').value; closeModal(); saveList(currentListData, renderBoard); }
        function addNewTier() { currentListData.tiers.push({name:'NEW',color:'#ccc',text:'#000',items:[]}); saveList(currentListData, renderBoard); }
        function deleteTier() { if(confirm('Delete Row?')) { currentListData.dock.push(...currentListData.tiers[editingTierIndex].items); currentListData.tiers.splice(editingTierIndex,1); closeModal(); saveList(currentListData, renderBoard); } }
        function moveTier(d) { const n = editingTierIndex+d; if(n>=0 && n<currentListData.tiers.length) { [currentListData.tiers[editingTierIndex], currentListData.tiers[n]] = [currentListData.tiers[n], currentListData.tiers[editingTierIndex]]; editingTierIndex = n; saveList(currentListData, renderBoard); } }

        function handleFiles(e) {
            if(!e.target.files.length)return; let l=0;
            Array.from(e.target.files).forEach(f=>{
                const r=new FileReader(); r.onload=ev=>{
                    const i=new Image(); i.src=ev.target.result; i.onload=()=>{
                        const c=document.createElement('canvas'), x=c.getContext('2d'), M=600; let w=i.width, h=i.height; if(w>M){h*=(M/w);w=M;} c.width=w; c.height=h; x.drawImage(i,0,0,w,h);
                        currentListData.dock.push({src:c.toDataURL('image/jpeg',0.9), h:100}); l++; if(l===e.target.files.length) saveList(currentListData, renderBoard);
                    }
                }; r.readAsDataURL(f);
            });
        }

        function saveList(data, cb) { data.updatedAt = new Date().toISOString(); const tx = db.transaction(['lists'], 'readwrite'); tx.objectStore('lists').put(data); tx.oncomplete = () => { loadMenu(); if(cb) cb(); }; }
        function deleteList(id) { if(confirm('Delete?')) { const tx = db.transaction(['lists'],'readwrite'); tx.objectStore('lists').delete(id); tx.oncomplete = loadMenu; } }
        function updateListName() { currentListData.name = document.getElementById('list-name').value; document.getElementById('tier-header').innerText = currentListData.name; saveList(currentListData); }
        function saveImage() { deselectImg(); window.scrollTo(0,0); html2canvas(document.getElementById('capture-area'),{scale:2, backgroundColor:'#000'}).then(c=>{ const a=document.createElement('a'); a.download=currentListData.name+'.png'; a.href=c.toDataURL(); a.click(); }); }
    </script>
</body>
</html>
