<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#09090b" id="meta-theme-color">
    <title>Tier List Pro</title>
    
    <link rel="icon" href="./icon.png" type="image/png">
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://bernardo-castilho.github.io/DragDropTouch/DragDropTouch.js"></script>
    <style>
        /* THEME VARIABLES */
        :root[data-theme="dark"] {
            --bg-base: #09090b; --bg-surface: #18181b; --bg-elevated: #27272a;
            --border-color: #27272a; --border-hover: #3f3f46;
            --text-main: #f4f4f5; --text-muted: #a1a1aa;
        }
        :root[data-theme="light"] {
            --bg-base: #f4f4f5; --bg-surface: #ffffff; --bg-elevated: #e4e4e7;
            --border-color: #d4d4d8; --border-hover: #a1a1aa;
            --text-main: #09090b; --text-muted: #52525b;
        }
        :root {
            --primary: #10b981; --primary-hover: #059669;
            --accent: #3b82f6; --danger: #ef4444;
            --radius-lg: 16px; --radius-md: 12px; --radius-sm: 8px;
            --shadow-float: 0 20px 40px -10px rgba(0,0,0,0.3);
            transition: background-color 0.3s, color 0.3s;
        }

        /* GLOBAL */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--bg-elevated); border-radius: 10px; }
        body { background: var(--bg-base); color: var(--text-main); margin: 0; padding: 0; padding-bottom: 100px; overscroll-behavior: none; -webkit-font-smoothing: antialiased; padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right); }
        .hidden { display: none !important; }
        
        button:focus-visible, input:focus-visible, .list-item:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }

        #app-container { width: 100%; max-width: 960px; margin: 0 auto; background: var(--bg-base); min-height: 100vh; border-left: 1px solid var(--border-color); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; position: relative; transition: all 0.3s; }
        
        /* OVERLAYS & TOASTS */
        #drop-overlay { position: fixed; inset: 0; background: rgba(16, 185, 129, 0.9); z-index: 10000; display: none; align-items: center; justify-content: center; color: white; font-size: clamp(1.2rem, 4vw, 2rem); font-weight: 700; backdrop-filter: blur(8px); border: 8px dashed rgba(255,255,255,0.5); pointer-events: none; text-align: center; padding: 20px;}
        #loading-overlay { z-index: 10002; flex-direction: column; color: white; font-weight: 600; font-size: 1.2rem; display: none; align-items: center; justify-content: center; position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(50px); background: var(--text-main); color: var(--bg-base); padding: 10px 24px; border-radius: 30px; font-weight: 600; opacity: 0; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); z-index: 10000; pointer-events: none; box-shadow: var(--shadow-float); white-space: nowrap; }
        #toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        #trash-zone { position: fixed; bottom: 100px; right: 30px; width: 70px; height: 70px; background: var(--danger); color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 1.8rem; z-index: 9999; box-shadow: 0 10px 25px rgba(239,68,68,0.5); border: 3px solid #fff; transition: transform 0.2s; }
        #trash-zone.hover { transform: scale(1.2); background: #dc2626; }

        /* MENU SCREEN & ANIMATIONS */
        #menu-screen { padding: 60px 20px; flex: 1; display: flex; flex-direction: column; align-items: center; }
        
        .app-header { display: flex; align-items: center; justify-content: center; width: 100%; max-width: 380px; margin-bottom: 30px; position: relative; }
        .app-title { color: var(--text-main); font-size: clamp(2rem, 6vw, 2.5rem); margin: 0; font-weight: 800; letter-spacing: -1px; text-transform: uppercase; }
        .app-title span { color: var(--primary); }
        .theme-toggle { position: absolute; right: 0; background: transparent; border: 1px solid var(--border-color); color: var(--text-main); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: 0.2s; }
        .theme-toggle:hover { background: var(--bg-elevated); }

        .menu-actions { display: flex; flex-direction: column; gap: 12px; width: 100%; max-width: 380px; margin-bottom: 50px; }
        .btn-create { width: 100%; padding: 16px; background: var(--primary); color: #fff; font-weight: 600; border: none; border-radius: var(--radius-md); font-size: 1.05rem; cursor: pointer; transition: all 0.2s; }
        .btn-data { width: 100%; padding: 14px; background: var(--bg-surface); color: var(--text-main); border: 1px solid var(--border-color); border-radius: var(--radius-md); font-weight: 500; cursor: pointer; transition: 0.2s; font-size: 0.95rem; }
        button:active { transform: scale(0.97); }

        #list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; width: 100%; }
        
        @keyframes cardEnter { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        
        .list-item { background: var(--bg-surface); border-radius: var(--radius-lg); overflow: hidden; border: 1px solid var(--border-color); cursor: pointer; transition: transform 0.1s ease, box-shadow 0.2s; display: flex; flex-direction: column; position: relative; opacity: 0; animation: cardEnter 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .list-item:hover { box-shadow: var(--shadow-float); }
        .list-item:active { transform: scale(0.97); }
        .btn-delete-list { position: absolute; top: 10px; right: 10px; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 8px; width: 34px; height: 34px; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; transition: 0.2s; backdrop-filter: blur(4px); z-index: 10; }
        .btn-delete-list:hover { background: rgba(239, 68, 68, 1); transform: scale(1.1); }
        .list-info-wrap { padding: 15px; display: flex; align-items: center; }
        
        /* EDITOR SCREEN */
        .top-bar { background: var(--bg-surface); opacity: 0.98; backdrop-filter: blur(12px); padding: 12px 15px; display: flex; gap: 8px; align-items: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; }
        .btn-back { background: transparent; color: var(--text-main); border: none; cursor: pointer; font-weight: bold; font-size: 1.1rem; padding: 5px 0; }
        .list-name-input { flex: 1; min-width: 100px; background: transparent; border: none; color: var(--text-main); font-size: 1.1rem; font-weight: 600; outline: none; text-overflow: ellipsis; padding: 0 5px; }
        .top-actions { display: flex; gap: 6px; flex-wrap: nowrap; }
        .btn-icon { background: var(--bg-elevated); color: var(--text-main); border: 1px solid var(--border-color); padding: 6px 10px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; }
        
        #btn-drag-toggle { background: var(--bg-surface); color: var(--primary); font-weight: 800; border: 1px solid var(--border-color); border-radius: 6px; padding: 6px 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: max-content; transition: all 0.2s;}

        .capture-wrapper { padding: 15px 12px; background: var(--bg-base); overflow-x: auto; touch-action: pan-y; } 
        #capture-area { background: #000; display: inline-flex; flex-direction: column; width: 100%; min-width: 100%; border-radius: 4px; overflow: hidden; outline: 1px solid var(--border-color); }
        .board-header-style { text-align: center; font-size: clamp(1.2rem, 4vw, 1.75rem); font-weight: 800; padding: 20px 10px; background: #000; color: #fff; text-transform: uppercase; border-bottom: 1px solid #000; cursor: pointer; transition: background 0.2s; }
        .board-header-style:hover { background: #1a1a1a; }
        #tier-board { display: flex; flex-direction: column; gap: 4px; background: #000; border-top: 1px solid #000; padding: 4px; } 
        
        .tier-row { display: flex; align-items: stretch; background: #1a1a1a; border-radius: 2px; overflow: hidden; transition: border-top 0.2s; }
        
        /* ƒê√É FIX LABEL XU·ªêNG D√íNG (TH√äM HYPHENS, B·ªò FONT M·ªöI, SIZE CHU·∫®N) */
        .tier-label-wrap { width: 85px; min-width: 85px; display: flex; align-items: center; justify-content: center; border-right: 1px solid #000; position: relative; cursor: grab; touch-action: none; }
        .tier-label-wrap:active { cursor: grabbing; }
        .tier-label { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; font-size: 12px; font-weight: 600; line-height: 1.25; color: #000; text-align: center; padding: 4px; word-wrap: break-word; overflow-wrap: break-word; word-break: break-word; hyphens: auto; -webkit-hyphens: auto; width: 100%; pointer-events: none; }
        @media (min-width: 600px) { 
            .tier-label-wrap { width: 130px; min-width: 130px; } 
            .tier-label { font-size: 16px; padding: 8px; font-weight: bold; }
        }
        
        .tier-content { flex: 1; display: flex; flex-wrap: wrap; align-content: flex-start; align-items: flex-start; background: #1a1a1a; padding: 4px; gap: 4px; position: relative; min-height: 85px; transition: background 0.2s; }
        
        /* IMAGE SHAPES & EFFECTS */
        .img-wrap { display: flex; align-items: center; justify-content: center; position: relative; cursor: grab; transition: transform 0.15s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.2s; margin: 0; padding: 0; touch-action: none; max-width: 100%; }
        .img-wrap.selected { outline: 3px solid var(--accent); outline-offset: -3px; z-index: 5; box-shadow: 0 4px 15px rgba(0,0,0,0.5); transform: scale(0.98); }
        .img-wrap:active { transform: scale(0.95); cursor: grabbing;}
        .img-wrap.dragging { opacity: 0.2; transform: scale(0.85); }
        
        body.scroll-mode .img-wrap, body.scroll-mode .tier-label-wrap { touch-action: auto !important; }

        .drag-placeholder { opacity: 0.7; outline: 3px dashed var(--primary); outline-offset: -3px; pointer-events: none !important; transform: scale(0.98); animation: fadeInGhost 0.2s; border-radius: 4px; overflow: hidden; filter: brightness(1.2); }
        @keyframes fadeInGhost { from { opacity: 0; transform: scale(0.8); } to { opacity: 0.7; transform: scale(0.98); } }
        
        .img-item { max-height: 100%; max-width: 100%; object-fit: contain; display: block; pointer-events: none; border-radius: 2px; }
        .img-caption { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.7); color: white; font-size: 11px; text-align: center; padding: 2px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; pointer-events: none; }
        
        /* CSS CHO SHAPE (VU√îNG/TR√íN) */
        .shape-square .img-wrap, .shape-circle .img-wrap { aspect-ratio: 1 / 1; }
        .shape-square .img-item, .shape-circle .img-item { width: 100%; height: 100%; object-fit: cover; }
        .shape-circle .img-wrap { border-radius: 50%; }
        .shape-circle .img-item { border-radius: 50%; }

        .dock-container { background: var(--bg-base); padding: 15px 12px; flex: 1; border-top: 1px solid var(--border-color); touch-action: pan-y; }
        #dock::-webkit-scrollbar { width: 6px; height: 6px; }
        #dock::-webkit-scrollbar-track { background: transparent; }
        #dock::-webkit-scrollbar-thumb { background: var(--border-hover); border-radius: 10px; }
        #dock { display: flex; flex-wrap: wrap; gap: 6px; padding: 10px 10px 40px 10px; background: var(--bg-surface); min-height: 100px; max-height: 35vh; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--radius-sm); box-shadow: inset 0 2px 10px rgba(0,0,0,0.1); align-content: flex-start;}

        .bottom-toolbar { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 960px; background: var(--bg-surface); opacity: 0.95; backdrop-filter: blur(16px); padding: 12px 20px; padding-bottom: max(12px, env(safe-area-inset-bottom)); display: flex; gap: 12px; border-top: 1px solid var(--border-color); z-index: 200; flex-wrap: wrap; }
        .btn-bottom { flex: 1; min-width: 140px; padding: 14px; border: none; border-radius: var(--radius-md); font-size: 0.95rem; font-weight: 600; cursor: pointer; text-align: center; transition: transform 0.1s; color: var(--text-main); }
        .btn-save { background: var(--bg-elevated); border: 1px solid var(--border-color); } 
        .btn-add { background: var(--text-main); color: var(--bg-base); } 
        
        #resize-control { position: fixed; bottom: calc(80px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); width: 90%; max-width: 420px; background: var(--bg-surface); opacity: 0.98; backdrop-filter: blur(20px); border: 1px solid var(--border-color); border-radius: var(--radius-lg); z-index: 250; padding: 20px; display: flex; flex-direction: column; gap: 16px; box-shadow: var(--shadow-float); }
        .size-slider-wrap { display: flex; align-items: center; gap: 10px; }
        .btn-size-step { background: var(--bg-elevated); color: var(--text-main); border: 1px solid var(--border-color); width: 34px; height: 34px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
        .btn-size-step:hover { background: var(--border-hover); }
        .resize-slider { flex: 1; height: 4px; background: var(--border-color); outline: none; -webkit-appearance: none; }
        
        .control-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-pill { padding: 12px 5px; border-radius: var(--radius-md); border: none; font-weight: 600; font-size: 0.85rem; cursor: pointer; background: var(--bg-elevated); color: var(--text-main); border: 1px solid var(--border-color); }
        
        @media (min-width: 768px) {
            .board-header-style { font-size: 2rem; padding: 30px; }
            .bottom-toolbar { padding: 15px 40px; gap: 20px; }
            .btn-bottom { font-size: 1.05rem; }
            #dock { max-height: 40vh; gap: 8px; padding: 15px; }
        }

        /* MODALS & ANIMATIONS */
        @keyframes overlayFadeIn { from { opacity: 0; backdrop-filter: blur(0px); } to { opacity: 1; backdrop-filter: blur(8px); } }
        @keyframes modalPopUp { 0% { opacity: 0; transform: scale(0.9) translateY(20px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 300; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); padding: 20px; animation: overlayFadeIn 0.2s ease-out forwards; }
        .modal { background: var(--bg-surface); padding: 28px; border-radius: var(--radius-lg); width: 100%; max-width: 400px; border: 1px solid var(--border-color); box-shadow: var(--shadow-float); animation: modalPopUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .modal h2 { margin-top: 0; color: var(--text-main); }
        .modal input[type="text"], .modal textarea { width: 100%; padding: 14px; background: var(--bg-base); color: var(--text-main); border: 1px solid var(--border-color); border-radius: var(--radius-md); outline: none; font-family: inherit; }
        .modal-btns { display: flex; flex-direction: column; gap: 10px; margin-top: 28px; }
        .modal-btns button { width: 100%; padding: 14px; border-radius: var(--radius-md); font-weight: 600; cursor: pointer; border: none; font-size: 1rem; }
        
        .tier-controls-btn { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-elevated); color: var(--text-main); cursor: pointer; font-weight: bold; font-size: 0.9rem; }
        .color-preset-btn { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid rgba(0,0,0,0.5); transition: transform 0.1s; }
        .color-preset-btn:hover { transform: scale(1.1); }
        .shortcut-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); color: var(--text-main); font-size: 0.9rem;}
        kbd { background: var(--bg-elevated); border: 1px solid var(--border-color); padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 0.85rem; color: var(--text-main); }

    </style>
</head>
<body>
    <div id="drop-overlay">Drag and drop images here to add</div>
    <div id="trash-zone" aria-label="Delete area">üóëÔ∏è</div>
    <div id="toast" role="alert">üíæ Auto-saved</div>
    
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-text" style="margin-top: 20px;">Processing...</p>
    </div>

    <div id="app-container">
        <div id="menu-screen">
            <div class="app-header">
                <h1 class="app-title">Tier<span>Maker</span></h1>
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle Theme" title="Light/Dark Theme">üåô</button>
            </div>
            
            <div class="menu-actions">
                <button class="btn-create" onclick="openCreateModal()">+ Create New Template</button>
                <button class="btn-data" onclick="openBackupMenu()">üì¶ Data & Backup</button>
            </div>
            <div id="list-container" role="list">Loading...</div>
        </div>
        
        <div id="editor-screen" class="hidden">
            <div class="top-bar">
                <button class="btn-back" onclick="backToMenu()" aria-label="Back">‚Äπ Back</button>
                <input type="text" id="list-name" class="list-name-input" oninput="debounceSaveName()" aria-label="Tier List Name">
                <div class="top-actions">
                    <button id="btn-drag-toggle" onclick="toggleDragMode()" title="Toggle Drag/Scroll Mode">‚úã Drag: ON</button>
                    <button class="btn-icon" onclick="openHelpModal()" aria-label="Shortcuts" title="Shortcuts">‚å®Ô∏è</button>
                    <button class="btn-icon" onclick="undo()" aria-label="Undo" title="Undo (Ctrl+Z)">‚Ü©Ô∏è</button>
                    <button class="btn-icon" onclick="redo()" aria-label="Redo" title="Redo (Ctrl+Y)">‚Ü™Ô∏è</button>
                </div>
            </div>
            
            <div class="capture-wrapper">
                <div id="capture-area">
                    <div id="tier-header" class="board-header-style" title="Rename tier list" onclick="openHeaderModal()">Tier List</div>
                    <div id="tier-board"></div>
                </div>
            </div>
            
            <div class="board-footer-actions" style="padding: 0 20px 20px 20px; display:flex; flex-wrap: wrap; gap:10px;">
                <button onclick="addNewTier()" class="btn-icon" style="flex:1;">+ Add Row</button>
                <button onclick="toggleImageShape()" id="btn-shape-toggle" class="btn-icon" style="flex:1;">üîÑ Shape: Original</button>
                <button onclick="toggleHeader()" class="btn-icon" style="flex:1;">Toggle Header</button>
                <button onclick="resetBoard()" class="btn-icon" style="color:var(--danger); border-color:var(--danger); flex:1;">Reset Board</button>
            </div>
            
            <div id="dock-container-box" class="dock-container">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
                    <span style="font-weight:bold; font-size:0.95rem; color:var(--text-muted);">Dock</span>
                    <input type="text" id="dock-search" placeholder="üîç Search images..." oninput="filterDock()" style="padding: 8px 14px; border-radius: 20px; border: 1px solid var(--border-color); background: var(--bg-surface); color: var(--text-main); font-size: 0.85rem; outline: none; width: 160px; transition: border-color 0.2s;">
                </div>
                <div id="dock" aria-label="Image Dock"></div>
            </div>
            
            <div class="bottom-toolbar">
                <button class="btn-bottom btn-save" onclick="saveImage()">Save Image (4K)</button>
                <button class="btn-bottom btn-add" onclick="document.getElementById('imgInput').click()">Add Images</button>
            </div>
            
            <input type="file" id="imgInput" multiple accept="image/*" onchange="handleFiles(event)" style="display:none">
        </div>

        <div id="resize-control" class="hidden">
            <div class="size-slider-wrap">
                <button class="btn-size-step" aria-label="Decrease size" onclick="adjustSize(-5); markDirty();">-</button>
                <input type="range" id="size-slider" min="40" max="300" value="85" oninput="resizeSelectedImg(this.value)" onchange="markDirty()" class="resize-slider" aria-label="Size slider">
                <button class="btn-size-step" aria-label="Increase size" onclick="adjustSize(5); markDirty();">+</button>
                <span id="size-val" style="min-width:45px; text-align:right; color:var(--text-main);">85px</span>
            </div>
            <div class="control-actions">
                <button class="btn-pill" onclick="moveToDock()">‚Üì To Dock</button>
                <button class="btn-pill" onclick="openCaptionModal()">‚úçÔ∏è Text</button>
                <button class="btn-pill" onclick="applyToAll()" style="background:var(--text-main); color:var(--bg-base);">‚ú¶ Match Size</button>
                <button class="btn-pill" onclick="deleteSelected()" style="background:var(--danger); color:white; border:none;">‚úï Delete (Del)</button>
            </div>
            <button onclick="deselectImg()" style="width:100%; margin-top:10px; background:transparent; border:1px solid var(--border-color); color:var(--text-main); padding:10px; border-radius:8px; cursor:pointer;">Done (Esc)</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal">
            <h2 id="confirm-title">Confirm</h2>
            <p id="confirm-desc" style="color:var(--text-muted); margin-bottom: 20px;">Are you sure?</p>
            <div class="modal-btns" style="flex-direction: row;">
                <button style="background:transparent; color:var(--text-main); border: 1px solid var(--border-color);" onclick="execCancel()">Cancel</button>
                <button style="background:var(--danger); color:white;" onclick="execConfirm()">Confirm</button>
            </div>
        </div>
    </div>

    <div id="create-modal-overlay" class="modal-overlay">
        <div class="modal">
            <h2>Create New Board</h2>
            <input type="text" id="new-template-name" placeholder="Enter board name..." onkeypress="if(event.key==='Enter') confirmCreateList()">
            <div class="modal-btns">
                <button class="btn-add" style="background:var(--text-main); color:var(--bg-base);" onclick="confirmCreateList()">Create</button>
                <button onclick="closeModal('create-modal-overlay')" style="background:transparent; color:var(--text-main);">Cancel</button>
            </div>
        </div>
    </div>
    
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal">
            <h2>Edit Row</h2>
            <input type="text" id="edit-name" onkeypress="if(event.key==='Enter') saveTierEdit()">
            <div style="margin-top:20px;">
                <label style="display:block; margin-bottom:8px; font-weight:bold; color:var(--text-main);">Background Color:</label>
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="color" id="edit-color-picker" style="cursor:pointer; width: 40px; height: 35px; border:none; background:transparent;" aria-label="Color picker">
                    <div style="display:flex; flex-wrap:wrap; gap:6px; max-width: 280px;">
                        <div class="color-preset-btn" style="background:#FF7F7F;" onclick="setTierColor('#FF7F7F')"></div>
                        <div class="color-preset-btn" style="background:#FFBF7F;" onclick="setTierColor('#FFBF7F')"></div>
                        <div class="color-preset-btn" style="background:#FFDF7F;" onclick="setTierColor('#FFDF7F')"></div>
                        <div class="color-preset-btn" style="background:#FFFF7F;" onclick="setTierColor('#FFFF7F')"></div>
                        <div class="color-preset-btn" style="background:#BFFF7F;" onclick="setTierColor('#BFFF7F')"></div>
                        <div class="color-preset-btn" style="background:#7FFF7F;" onclick="setTierColor('#7FFF7F')"></div>
                        <div class="color-preset-btn" style="background:#7FFFFF;" onclick="setTierColor('#7FFFFF')"></div>
                        <div class="color-preset-btn" style="background:#7FBFFF;" onclick="setTierColor('#7FBFFF')"></div>
                        <div class="color-preset-btn" style="background:#7F7FFF;" onclick="setTierColor('#7F7FFF')"></div>
                        <div class="color-preset-btn" style="background:#FF7FFF;" onclick="setTierColor('#FF7FFF')"></div>
                        <div class="color-preset-btn" style="background:#BF7FFF;" onclick="setTierColor('#BF7FFF')"></div>
                        <div class="color-preset-btn" style="background:#333333;" onclick="setTierColor('#333333')"></div>
                        <div class="color-preset-btn" style="background:#888888;" onclick="setTierColor('#888888')"></div>
                        <div class="color-preset-btn" style="background:#CCCCCC;" onclick="setTierColor('#CCCCCC')"></div>
                        <div class="color-preset-btn" style="background:#FFFFFF;" onclick="setTierColor('#FFFFFF')"></div>
                    </div>
                </div>
            </div>
            <div style="margin-top:25px; display:flex; gap:10px;">
                <button class="tier-controls-btn" onclick="moveTierUp()">üîº Move Up</button>
                <button class="tier-controls-btn" onclick="moveTierDown()">üîΩ Move Down</button>
            </div>
            <div class="modal-btns">
                <button style="background:var(--text-main); color:var(--bg-base);" onclick="saveTierEdit()">Save changes</button>
                <button style="background:var(--danger); color:#fff; border:none;" onclick="deleteTier()">Delete Row</button>
                <button style="background:transparent; color:var(--text-main); border: 1px solid var(--border-color);" onclick="closeModal('modal-overlay')">Close</button>
            </div>
        </div>
    </div>

    <div id="caption-modal-overlay" class="modal-overlay">
        <div class="modal">
            <h2>Image Caption</h2>
            <input type="text" id="caption-input" placeholder="Character name..." onkeypress="if(event.key==='Enter') saveCaption()">
            <div class="modal-btns">
                <button style="background:var(--text-main); color:var(--bg-base);" onclick="saveCaption()">Save</button>
                <button style="background:transparent; color:var(--text-main);" onclick="closeModal('caption-modal-overlay')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="help-modal" class="modal-overlay">
        <div class="modal">
            <h2>System Shortcuts</h2>
            <div style="margin-top: 15px;">
                <div class="shortcut-row"><span>Manual Save</span> <kbd>Ctrl + S</kbd></div>
                <div class="shortcut-row"><span>Undo</span> <kbd>Ctrl + Z</kbd></div>
                <div class="shortcut-row"><span>Redo</span> <kbd>Ctrl + Y</kbd></div>
                <div class="shortcut-row"><span>Delete selected image</span> <kbd>Del / Back</kbd></div>
                <div class="shortcut-row"><span>Deselect / Exit</span> <kbd>Esc</kbd></div>
            </div>
            <div class="modal-btns">
                <button style="background:var(--primary); color:#fff;" onclick="closeModal('help-modal')">Got it</button>
            </div>
        </div>
    </div>

    <div id="backup-modal-overlay" class="modal-overlay">
        <div class="modal">
            <h2>Data & Backup</h2>
            <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom: 20px;">Backup via file or direct Copy/Paste to transfer to another device.</p>
            <div class="modal-btns">
                <button style="background:var(--primary); color:#fff;" onclick="exportData()">‚¨áÔ∏è Export Data (Download file)</button>
                <button style="background:var(--accent); color:#fff;" onclick="document.getElementById('importInput').click()">‚¨ÜÔ∏è Import Data (Restore)</button>
                <button style="background:#f59e0b; color:#fff; margin-top:10px;" onclick="copyDataToClipboard()">üìã Copy Code (Paste to another device)</button>
                <button style="background:#8b5cf6; color:#fff; margin-top:5px;" onclick="pasteDataFromClipboard()">üìù Paste Code (Get from another device)</button>
                <button style="background:var(--danger); color:#fff; margin-top:15px;" onclick="wipeAllData()">üóëÔ∏è Wipe all data (Reset)</button>
                <button style="background:transparent; color:var(--text-main); margin-top:5px;" onclick="closeModal('backup-modal-overlay')">Close</button>
            </div>
            <input type="file" id="importInput" accept=".json" onchange="importData(event)" style="display:none" aria-label="Import data file">
        </div>
    </div>

    <div id="manual-paste-modal" class="modal-overlay">
        <div class="modal">
            <h2>Paste Data Code</h2>
            <p style="color:var(--text-muted); font-size:0.85rem;">Browser blocks auto-paste. Click the box below and press <kbd>Ctrl+V</kbd>.</p>
            <textarea id="manual-paste-textarea" rows="4" placeholder="Paste code here..."></textarea>
            <div class="modal-btns">
                <button style="background:#8b5cf6; color:#fff;" onclick="processManualPaste()">Restore Data</button>
                <button style="background:transparent; color:var(--text-main);" onclick="closeModal('manual-paste-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // 1. INLINE PWA
        (function initPWA() {
            try {
                const manifestData = { name: "Tier List Pro", short_name: "TierMaker", display: "standalone", background_color: "#09090b", theme_color: "#10b981", start_url: location.href, icons: [ { src: "./icon.png", sizes: "192x192", type: "image/png" }, { src: "./icon.png", sizes: "512x512", type: "image/png" } ] };
                const manifestBlob = new Blob([JSON.stringify(manifestData)], {type: 'application/manifest+json'});
                document.head.insertAdjacentHTML('beforeend', `<link rel="manifest" href="${URL.createObjectURL(manifestBlob)}">`);
                if ('serviceWorker' in navigator) {
                    const swCode = `const CACHE_NAME = 'tier-list-cache-v1'; self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME))); self.addEventListener('fetch', e => { e.respondWith(caches.match(e.request).then(res => res || fetch(e.request).catch(() => new Response('Offline mode')))); });`;
                    const swBlob = new Blob([swCode], {type: 'application/javascript'});
                    navigator.serviceWorker.register(URL.createObjectURL(swBlob)).catch(err => console.log(err));
                }
            } catch (error) {}
        })();

        // 2. CORE ENGINE & UTILS
        const DB_NAME = 'TierMaker_V26_Pro'; 
        let db, currentListData, selectedImgObj = null, editingTierIndex = -1, draggedItem = null, draggedRowIdx = null;
        let currentPlaceholder = null; 
        let stateHistory = [], historyIndex = -1;
        let saveTimeout, toastTimeout, confirmAction = null, confirmCancelAction = null;
        let isDirty = false;
        let isDragMode = true;
        
        const autoSaveInterval = setInterval(() => { if (isDirty && currentListData) { saveListSilent(currentListData); showToast('üíæ Auto-saved'); isDirty = false; } }, 3000);
        function markDirty() { isDirty = true; }
        function escapeHTML(str) { return !str ? '' : str.replace(/[&<>'"]/g, tag => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[tag] || tag)); }
        function initTheme() { const savedTheme = localStorage.getItem('theme') || 'dark'; document.documentElement.setAttribute('data-theme', savedTheme); updateThemeIcon(savedTheme); }
        function toggleTheme() { const current = document.documentElement.getAttribute('data-theme'); const target = current === 'dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-theme', target); localStorage.setItem('theme', target); updateThemeIcon(target); }
        function updateThemeIcon(theme) { const btn = document.querySelector('.theme-toggle'); if (btn) btn.innerText = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è'; document.getElementById('meta-theme-color').content = theme === 'dark' ? '#09090b' : '#f4f4f5'; }

        window.onload = () => { 
            initTheme();
            const req = indexedDB.open(DB_NAME, 1); 
            req.onupgradeneeded = e => { e.target.result.createObjectStore('lists', {keyPath:'id'}); };
            req.onsuccess = e => { db = e.target.result; loadMenu(); initGlobalFileDrop(); initKeyboardShortcuts(); initGlobalClickAndDrop(); };
        };
        
        function showToast(msg) { const toast = document.getElementById('toast'); toast.innerText = msg; toast.classList.add('show'); clearTimeout(toastTimeout); toastTimeout = setTimeout(() => toast.classList.remove('show'), 2000); }
        function openConfirm(title, desc, onConfirm, onCancel = null) { document.getElementById('confirm-title').innerText = title; document.getElementById('confirm-desc').innerText = desc; confirmAction = onConfirm; confirmCancelAction = onCancel; document.getElementById('confirm-modal').style.display = 'flex'; }
        function execConfirm() { if (confirmAction) confirmAction(); closeModal('confirm-modal'); }
        function execCancel() { if (confirmCancelAction) confirmCancelAction(); closeModal('confirm-modal'); }

        // 3. EVENT LISTENERS & FIXES
        function initGlobalClickAndDrop() {
            const handleOutsideClick = (e) => { 
                if (selectedImgObj) { 
                    const isClickInsideImage = e.target.closest('.img-wrap'); 
                    const isClickInsideControl = e.target.closest('#resize-control'); 
                    if (!isClickInsideImage && !isClickInsideControl) deselectImg(); 
                } 
            };
            document.addEventListener('mousedown', handleOutsideClick); 
            document.addEventListener('touchstart', handleOutsideClick, {passive: true});

            const dockContainer = document.getElementById('dock-container-box');
            dockContainer.ondragover = e => { 
                e.preventDefault(); 
                if (isDragMode && draggedItem && draggedItem.type !== 'row') e.dataTransfer.dropEffect = 'move'; 
            };
            dockContainer.ondrop = e => { 
                e.preventDefault(); 
                if (isDragMode && draggedItem && draggedItem.type !== 'row') {
                    let oldArray = (draggedItem.type === 'tier') ? currentListData.tiers[draggedItem.r].items : currentListData.dock;
                    oldArray.splice(draggedItem.i, 1);
                    currentListData.dock.push(draggedItem.data);
                    commitChange();
                }
            };
        }

        function initGlobalFileDrop() { 
            const overlay = document.getElementById('drop-overlay'); 
            window.addEventListener('dragenter', e => { e.preventDefault(); if (draggedItem) return; if (e.dataTransfer.types && e.dataTransfer.types.includes("Files")) { e.dataTransfer.dropEffect = 'copy'; overlay.style.display = 'flex'; } }); 
            overlay.addEventListener('dragleave', e => { e.preventDefault(); overlay.style.display = 'none'; }); 
            window.addEventListener('dragover', e => { e.preventDefault(); if (draggedItem) { e.dataTransfer.dropEffect = 'move'; return; } e.dataTransfer.dropEffect = 'copy'; });
            window.addEventListener('drop', e => { e.preventDefault(); if (draggedItem) return; overlay.style.display = 'none'; if (e.dataTransfer.files && e.dataTransfer.files.length > 0) { if (!currentListData) { alert("Please open a tier list before adding images!"); return; } handleFiles({target: {files: e.dataTransfer.files}}); } }); 
        }

        function initKeyboardShortcuts() { window.addEventListener('keydown', e => { if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return; if (e.ctrlKey || e.metaKey) { if (e.key.toLowerCase() === 'z') { e.preventDefault(); undo(); } if (e.key.toLowerCase() === 'y') { e.preventDefault(); redo(); } if (e.key.toLowerCase() === 's') { e.preventDefault(); if (currentListData) { saveListSilent(currentListData); showToast('üíæ Auto-saved'); isDirty = false; } } } if (e.key === 'Delete' || e.key === 'Backspace') { if (selectedImgObj) { e.preventDefault(); deleteSelected(); } } if (e.key === 'Escape') { if (selectedImgObj) deselectImg(); document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none'); } }); }
        function isValidTierData(data) { try { if (!Array.isArray(data)) return false; return data.every(l => l.id && typeof l.name === 'string' && Array.isArray(l.tiers) && Array.isArray(l.dock)); } catch (e) { return false; } }

        function toggleDragMode() {
            isDragMode = !isDragMode;
            const btn = document.getElementById('btn-drag-toggle');
            if (isDragMode) {
                btn.innerHTML = '‚úã Drag: ON';
                btn.style.color = 'var(--primary)';
                btn.style.borderColor = 'var(--border-color)';
                btn.style.background = 'var(--bg-surface)';
                document.body.classList.remove('scroll-mode');
                document.querySelectorAll('.img-wrap, .tier-row, .tier-label-wrap').forEach(el => {
                    el.setAttribute('draggable', 'true');
                    if(el.classList.contains('img-wrap') || el.classList.contains('tier-label-wrap')) el.style.cursor = 'grab';
                });
            } else {
                btn.innerHTML = '‚ÜïÔ∏è Scroll: ON';
                btn.style.color = 'var(--bg-base)';
                btn.style.borderColor = 'var(--text-main)';
                btn.style.background = 'var(--text-main)';
                document.body.classList.add('scroll-mode');
                document.querySelectorAll('.img-wrap, .tier-row, .tier-label-wrap').forEach(el => {
                    el.removeAttribute('draggable');
                    if(el.classList.contains('img-wrap') || el.classList.contains('tier-label-wrap')) el.style.cursor = 'pointer';
                });
            }
        }

        // T√çNH NƒÇNG T√åM KI·∫æM TRONG KHO (DOCK SEARCH)
        function filterDock() {
            const query = document.getElementById('dock-search').value.toLowerCase();
            const dockItems = document.getElementById('dock').querySelectorAll('.img-wrap');
            dockItems.forEach(wrap => {
                const name = wrap.dataset.name || '';
                if (name.includes(query)) wrap.style.display = 'flex';
                else wrap.style.display = 'none';
            });
        }

        // T√çNH NƒÇNG CHUY·ªÇN H√åNH D√ÅNG ·∫¢NH (SHAPE TOGGLE)
        function toggleImageShape() {
            if(!currentListData.shape || currentListData.shape === 'auto') currentListData.shape = 'square';
            else if(currentListData.shape === 'square') currentListData.shape = 'circle';
            else currentListData.shape = 'auto';
            commitChange();
        }

        // 5. MENU & LIST MANAGEMENT
        function loadMenu() { 
            try { db.transaction(['lists']).objectStore('lists').getAll().onsuccess = e => { 
                const list = e.target.result; const container = document.getElementById('list-container'); 
                if (list.length === 0) { container.innerHTML = '<div style="text-align:center; padding: 60px 20px; color: var(--text-muted); grid-column: 1/-1; font-size: 1.1rem;">üìÅ<br><br>You don\'t have any tier lists yet.<br>Click <b>+ Create New Template</b> above!</div>'; return; }
                let html = ''; list.forEach((l, index) => { const safeName = escapeHTML(l.name); const delay = index * 0.05; html += `<div class="list-item" style="animation-delay: ${delay}s" tabindex="0" aria-label="Board ${safeName}" onclick="openList('${l.id}')" onkeypress="if(event.key==='Enter') openList('${l.id}')"><button class="btn-delete-list" aria-label="Delete board" title="Delete board" onclick="deleteSingleList(event, '${l.id}', '${safeName}')">üóëÔ∏è</button><img src="${l.thumbnail || ''}" alt="Thumbnail" style="width:100%; height:180px; object-fit:cover; object-position:top; background:#000;"><div class="list-info-wrap"><h3 style="margin:0; font-size:1rem; flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${safeName}</h3></div></div>`; }); container.innerHTML = html; }; 
            } catch (err) {} 
        }
        function deleteSingleList(e, id, name) { e.stopPropagation(); openConfirm("Delete Board", `Are you sure you want to delete the board "${name}"?`, () => { try { const tx = db.transaction(['lists'], 'readwrite'); tx.objectStore('lists').delete(id); tx.oncomplete = () => loadMenu(); } catch (err) {} }); }
        function saveListSilent(d) { try { d.updatedAt = new Date().toISOString(); db.transaction(['lists'], 'readwrite').objectStore('lists').put(d); } catch(e) {} }
        function commitChange() { pushHistory(); renderBoard(); markDirty(); }
        function commitChangeSilent() { pushHistory(); markDirty(); }
        function pushHistory() { const s = JSON.stringify(currentListData); if (stateHistory[historyIndex] !== s) { stateHistory = stateHistory.slice(0, historyIndex+1); stateHistory.push(s); historyIndex++; if (stateHistory.length > 15) { stateHistory.shift(); historyIndex--; } } }
        function undo() { if (historyIndex > 0) { historyIndex--; currentListData = JSON.parse(stateHistory[historyIndex]); renderBoard(); markDirty(); showToast("‚Ü©Ô∏è Undone"); } }
        function redo() { if (historyIndex < stateHistory.length-1) { historyIndex++; currentListData = JSON.parse(stateHistory[historyIndex]); renderBoard(); markDirty(); showToast("‚Ü™Ô∏è Redone"); } }
        function openList(id) { showLoading('Opening...'); try { db.transaction(['lists']).objectStore('lists').get(id).onsuccess = e => { currentListData = e.target.result; stateHistory = [JSON.stringify(currentListData)]; historyIndex = 0; isDirty = false; document.getElementById('menu-screen').classList.add('hidden'); document.getElementById('editor-screen').classList.remove('hidden'); document.getElementById('list-name').value = currentListData.name; renderBoard(); hideLoading(); }; } catch (err) { hideLoading(); } }
        
        function getInsertionNode(container, clientX, clientY) {
            const elements = [...container.querySelectorAll('.img-wrap:not(.dragging):not(.drag-placeholder)')];
            for (let i = 0; i < elements.length; i++) {
                const box = elements[i].getBoundingClientRect();
                if (clientY >= box.top && clientY <= box.bottom) {
                    if (clientX < box.left + box.width / 2) return elements[i];
                } else if (clientY < box.top) { return elements[i]; }
            }
            return null;
        }

        // 6. BOARD RENDER & DRAG-DROP
        function renderBoard() {
            try {
                // X·ª≠ l√Ω n√∫t Shape
                const editorScreen = document.getElementById('editor-screen');
                editorScreen.classList.remove('shape-square', 'shape-circle');
                const shapeBtn = document.getElementById('btn-shape-toggle');
                if(currentListData.shape === 'square') { editorScreen.classList.add('shape-square'); shapeBtn.innerText = 'üîÑ Shape: Square'; }
                else if(currentListData.shape === 'circle') { editorScreen.classList.add('shape-circle'); shapeBtn.innerText = 'üîÑ Shape: Circle'; }
                else { shapeBtn.innerText = 'üîÑ Shape: Original'; }

                const board = document.getElementById('tier-board'); board.innerHTML = '';
                const hEl = document.getElementById('tier-header'); hEl.innerText = currentListData.name; hEl.style.display = currentListData.headerVisible === false ? 'none' : 'block';

                currentListData.tiers.forEach((t, i) => {
                    const row = document.createElement('div'); row.className = 'tier-row'; row.style.backgroundColor = t.color; 
                    if(isDragMode) row.draggable = true; 
                    
                    row.ondragover = e => { e.preventDefault(); if (isDragMode && draggedRowIdx !== null) { e.dataTransfer.dropEffect = 'move'; e.currentTarget.style.borderTop = "3px solid #10b981"; } };
                    row.ondragleave = e => { if (isDragMode && draggedRowIdx !== null) e.currentTarget.style.borderTop = ""; };
                    row.ondrop = e => { e.preventDefault(); e.currentTarget.style.borderTop = ""; if (isDragMode && draggedRowIdx !== null) { const tmp = currentListData.tiers.splice(draggedRowIdx, 1)[0]; currentListData.tiers.splice(i, 0, tmp); draggedRowIdx = null; commitChange(); } };
                    
                    const labelWrap = document.createElement('div'); labelWrap.className = 'tier-label-wrap';
                    labelWrap.title = "Drag to reorder row. Click to edit.";
                    labelWrap.onclick = () => openEditModal(i);
                    if(isDragMode) labelWrap.draggable = true; 
                    else labelWrap.style.cursor = 'pointer';

                    labelWrap.ondragstart = e => { if(!isDragMode) return; draggedRowIdx = i; e.dataTransfer.effectAllowed = 'move'; }; 
                    
                    const label = document.createElement('div'); label.className = 'tier-label'; label.innerText = t.name; labelWrap.appendChild(label);

                    const content = document.createElement('div'); content.className = 'tier-content';
                    
                    content.ondragover = e => { 
                        e.preventDefault(); 
                        if (isDragMode && draggedItem && draggedItem.type !== 'row') { 
                            e.dataTransfer.dropEffect = 'move'; 
                            if (currentPlaceholder) {
                                const afterElement = getInsertionNode(content, e.clientX, e.clientY);
                                if (afterElement !== currentPlaceholder.nextElementSibling) {
                                    if (afterElement) content.insertBefore(currentPlaceholder, afterElement);
                                    else content.appendChild(currentPlaceholder);
                                }
                            }
                        } 
                    };
                    
                    content.ondrop = e => { 
                        e.preventDefault(); 
                        e.stopPropagation(); 
                        if (isDragMode && draggedItem && draggedItem.type !== 'row') { 
                            let dropIndex = currentListData.tiers[i].items.length;
                            if (currentPlaceholder && currentPlaceholder.parentNode === content) {
                                const elements = [...content.querySelectorAll('.img-wrap:not(.dragging)')];
                                dropIndex = elements.indexOf(currentPlaceholder);
                            }
                            let oldArray = (draggedItem.type === 'tier') ? currentListData.tiers[draggedItem.r].items : currentListData.dock;
                            let newArray = currentListData.tiers[i].items;
                            oldArray.splice(draggedItem.i, 1);
                            newArray.splice(dropIndex, 0, draggedItem.data);
                            commitChange(); 
                        } 
                    };
                    
                    t.items.forEach((img, idx) => content.appendChild(createImg(img, 'tier', i, idx)));
                    row.appendChild(labelWrap); row.appendChild(content); board.appendChild(row);
                });
                
                const dock = document.getElementById('dock'); dock.innerHTML = '';
                
                dock.ondragover = e => { 
                    e.preventDefault(); 
                    if(isDragMode && draggedItem && draggedItem.type !== 'row') {
                        e.dataTransfer.dropEffect = 'move'; 
                        if (currentPlaceholder) {
                            const afterElement = getInsertionNode(dock, e.clientX, e.clientY);
                            if (afterElement !== currentPlaceholder.nextElementSibling) {
                                if (afterElement) dock.insertBefore(currentPlaceholder, afterElement);
                                else dock.appendChild(currentPlaceholder);
                            }
                        }
                    }
                };
                dock.ondrop = e => { 
                    e.preventDefault(); 
                    e.stopPropagation(); 
                    if (isDragMode && draggedItem && draggedItem.type !== 'row') { 
                        let dropIndex = currentListData.dock.length;
                        if (currentPlaceholder && currentPlaceholder.parentNode === dock) {
                            const elements = [...dock.querySelectorAll('.img-wrap:not(.dragging)')];
                            dropIndex = elements.indexOf(currentPlaceholder);
                        }
                        let oldArray = (draggedItem.type === 'tier') ? currentListData.tiers[draggedItem.r].items : currentListData.dock;
                        let newArray = currentListData.dock;
                        oldArray.splice(draggedItem.i, 1);
                        newArray.splice(dropIndex, 0, draggedItem.data);
                        commitChange(); 
                    } 
                };
                
                currentListData.dock.forEach((img, idx) => dock.appendChild(createImg(img, 'dock', null, idx)));
                filterDock(); // G·ªåI L·∫†I H√ÄM L·ªåC SAU KHI RENDER
            } catch (err) {}
        }

        function createImg(data, type, r, i) {
            const wrap = document.createElement('div'); wrap.className = 'img-wrap'; 
            wrap.style.height = (type==='tier' ? data.h : 85) + 'px';
            wrap.dataset.name = (data.name || '').toLowerCase(); // G·∫Øn t√™n ·∫©n ƒë·ªÉ d√πng cho Search Bar
            
            if(isDragMode) wrap.draggable = true;
            else wrap.style.cursor = 'pointer';
            
            const img = document.createElement('img'); img.src = data.src; img.className = 'img-item'; 
            wrap.appendChild(img);
            
            if (data.caption) { const c = document.createElement('div'); c.className = 'img-caption'; c.innerText = data.caption; wrap.appendChild(c); }
            wrap.onclick = e => { e.stopPropagation(); clickImg(wrap, data, type, r, i); };
            
            wrap.ondragstart = e => { 
                if(!isDragMode) return;
                e.stopPropagation(); 
                draggedItem = {data, type, r, i}; 
                e.dataTransfer.effectAllowed = 'move'; 
                const tz = document.getElementById('trash-zone'); tz.style.display='flex'; tz.classList.remove('hover');
                
                setTimeout(() => {
                    wrap.classList.add('dragging'); 
                    currentPlaceholder = wrap.cloneNode(true);
                    currentPlaceholder.classList.remove('dragging', 'selected');
                    currentPlaceholder.classList.add('drag-placeholder');
                }, 0); 
            };
            
            wrap.ondragend = () => { 
                draggedItem = null; 
                document.getElementById('trash-zone').style.display='none'; 
                wrap.classList.remove('dragging'); 
                if (currentPlaceholder && currentPlaceholder.parentNode) { currentPlaceholder.parentNode.removeChild(currentPlaceholder); }
                currentPlaceholder = null;
            };

            return wrap;
        }

        const tz = document.getElementById('trash-zone');
        tz.ondragover = e => { e.preventDefault(); if(isDragMode && draggedItem) { e.dataTransfer.dropEffect = 'move'; tz.classList.add('hover'); } };
        tz.ondragleave = () => tz.classList.remove('hover');
        tz.ondrop = () => { if (isDragMode && draggedItem) { let oldArray = (draggedItem.type === 'tier') ? currentListData.tiers[draggedItem.r].items : currentListData.dock; oldArray.splice(draggedItem.i, 1); commitChange(); tz.classList.remove('hover'); } };

        // 7. EDITING & MEDIA CONTROLS
        function clickImg(dom, data, type, r, i) { if (!selectedImgObj) { selectedImgObj = {dom, data, type, r, i}; dom.classList.add('selected'); document.getElementById('resize-control').classList.remove('hidden'); document.getElementById('size-slider').value = data.h; document.getElementById('size-val').innerText = data.h + 'px'; } else if (selectedImgObj.dom === dom) { deselectImg(); } }
        function deselectImg() { if (selectedImgObj) { selectedImgObj.dom.classList.remove('selected'); selectedImgObj = null; document.getElementById('resize-control').classList.add('hidden'); } }
        function resizeSelectedImg(h) { if (selectedImgObj) { h = parseInt(h); selectedImgObj.data.h = h; selectedImgObj.dom.style.height = h+'px'; document.getElementById('size-val').innerText = h+'px'; document.getElementById('size-slider').value = h; } }
        function adjustSize(d) { if (selectedImgObj) { let newH = parseInt(document.getElementById('size-slider').value) + d; newH = Math.max(40, Math.min(300, newH)); resizeSelectedImg(newH); } }
        function applyToAll() { const h = selectedImgObj.data.h; currentListData.tiers.forEach(t => t.items.forEach(i => i.h = h)); currentListData.dock.forEach(i => i.h = h); commitChange(); }
        function showLoading(text) { document.getElementById('loading-text').innerText = text; document.getElementById('loading-overlay').style.display='flex'; }
        function hideLoading() { document.getElementById('loading-overlay').style.display='none'; }

        function saveImage() { 
            deselectImg(); 
            showLoading('Exporting 4K Image...'); 
            setTimeout(() => { 
                html2canvas(document.getElementById('capture-area'), { scale: 4, backgroundColor: null, useCORS: true }).then(c => { 
                    const a = document.createElement('a'); a.download = 'TierList.png'; a.href = c.toDataURL('image/png', 1.0); a.click(); 
                    hideLoading(); showToast("‚úÖ Image saved successfully"); 
                }).catch(err => { 
                    hideLoading(); alert('Export error: Uploaded image may not support exporting (CORS error).'); 
                }); 
            }, 100); 
        }

        function processFilesArray(filesToProcess) { 
            if (filesToProcess.length === 0) { document.getElementById('imgInput').value = ''; return; } 
            showLoading("Processing images..."); 
            let processed = 0; 
            filesToProcess.forEach(f => { 
                const r = new FileReader(); 
                r.onload = ev => { 
                    const i = new Image(); i.src = ev.target.result; 
                    i.onload = () => { 
                        try { 
                            const c = document.createElement('canvas'); const x = c.getContext('2d'); 
                            const M = 1500; 
                            let w = i.width; let h = i.height; 
                            if (w > M) { h *= (M/w); w = M; } 
                            c.width = w; c.height = h; x.drawImage(i, 0, 0, w, h); 
                            currentListData.dock.push({ src: c.toDataURL('image/jpeg', 0.8), h: 85, name: f.name }); 
                        } catch(err) { } 
                        finally { processed++; if (processed === filesToProcess.length) { commitChange(); hideLoading(); } } 
                    }; 
                    i.onerror = () => { processed++; if (processed === filesToProcess.length) { commitChange(); hideLoading(); } } 
                }; r.readAsDataURL(f); 
            }); document.getElementById('imgInput').value = ''; 
        }

        function handleFiles(e) { 
            const files = Array.from(e.target.files).filter(f => { if (!f.type.startsWith('image/')) { alert(`‚ùå File "${escapeHTML(f.name)}" is not an image.`); return false; } return true; }); 
            if (files.length === 0) { e.target.value = ''; return; } 
            const existingNames = new Set(); 
            if (currentListData) { 
                currentListData.dock.forEach(img => { if(img.name) existingNames.add(img.name); }); 
                currentListData.tiers.forEach(t => { t.items.forEach(img => { if(img.name) existingNames.add(img.name); }); }); 
            } 
            const newFiles = []; const duplicateFiles = []; 
            files.forEach(f => { if (existingNames.has(f.name)) duplicateFiles.push(f); else newFiles.push(f); }); 
            if (duplicateFiles.length > 0) { 
                const dupNames = duplicateFiles.map(f => escapeHTML(f.name)).slice(0, 3).join(', '); const extraDup = duplicateFiles.length > 3 ? ` and ${duplicateFiles.length - 3} other files` : ''; 
                const msg = `Detected ${duplicateFiles.length} duplicate images (e.g., ${dupNames}${extraDup}).\n\nDo you want to upload these DUPLICATES?`; 
                openConfirm("Duplicates Detected", msg, () => processFilesArray([...newFiles, ...duplicateFiles]), () => processFilesArray(newFiles) ); 
            } else { processFilesArray(newFiles); } 
        }

        function openHeaderModal() { const inputName = document.getElementById('list-name'); inputName.focus(); inputName.select(); }
        function openCreateModal() { document.getElementById('create-modal-overlay').style.display='flex'; document.getElementById('new-template-name').focus(); }
        function openHelpModal() { document.getElementById('help-modal').style.display='flex'; }
        
        // T·ª∞ ƒê·ªòNG T·∫†O B·∫¢NG CHU·∫®N (S, A, B, C, D, F)
        function confirmCreateList() { 
            const name = document.getElementById('new-template-name').value.trim() || 'New Board'; 
            try { 
                db.transaction(['lists']).objectStore('lists').getAll().onsuccess = e => { 
                    const list = e.target.result; 
                    if (list.some(l => l.name.toLowerCase() === name.toLowerCase())) { alert('‚ö†Ô∏è Board name already exists! Please choose another name.'); return; } 
                    showLoading("Creating..."); 
                    setTimeout(() => { 
                        const newList = { 
                            id: 'list_'+Date.now(), 
                            name: name, 
                            tiers: [
                                {name:'S', color:'#FF7F7F', items:[]},
                                {name:'A', color:'#FFBF7F', items:[]},
                                {name:'B', color:'#FFDF7F', items:[]},
                                {name:'C', color:'#FFFF7F', items:[]},
                                {name:'D', color:'#BFFF7F', items:[]},
                                {name:'F', color:'#7F7FFF', items:[]}
                            ], 
                            dock: [],
                            shape: 'auto'
                        }; 
                        saveListSilent(newList); loadMenu(); closeModal('create-modal-overlay'); document.getElementById('new-template-name').value = ''; hideLoading(); 
                    }, 300); 
                }; 
            } catch (err) {} 
        }
        
        function openEditModal(i) { editingTierIndex = i; const t = currentListData.tiers[i]; document.getElementById('edit-name').value = t.name; document.getElementById('edit-color-picker').value = t.color; document.getElementById('modal-overlay').style.display='flex'; document.getElementById('edit-name').focus(); }
        function setTierColor(color) { document.getElementById('edit-color-picker').value = color; }
        function saveTierEdit() { currentListData.tiers[editingTierIndex].name = document.getElementById('edit-name').value; currentListData.tiers[editingTierIndex].color = document.getElementById('edit-color-picker').value; closeModal('modal-overlay'); commitChange(); }
        function moveTierUp() { if (editingTierIndex > 0) { const tmp = currentListData.tiers[editingTierIndex]; currentListData.tiers[editingTierIndex] = currentListData.tiers[editingTierIndex - 1]; currentListData.tiers[editingTierIndex - 1] = tmp; editingTierIndex--; commitChange(); } }
        function moveTierDown() { if (editingTierIndex < currentListData.tiers.length - 1) { const tmp = currentListData.tiers[editingTierIndex]; currentListData.tiers[editingTierIndex] = currentListData.tiers[editingTierIndex + 1]; currentListData.tiers[editingTierIndex + 1] = tmp; editingTierIndex++; commitChange(); } }
        function deleteTier() { openConfirm("Delete Row", "Delete this row? Images in this row (if any) will also be deleted.", () => { currentListData.tiers.splice(editingTierIndex, 1); closeModal('modal-overlay'); commitChange(); }); }
        function addNewTier() { currentListData.tiers.push({name:'NEW', color:'#1a1a1a', items:[]}); commitChange(); }
        function toggleHeader() { currentListData.headerVisible = currentListData.headerVisible === false ? true : false; commitChange(); }
        function resetBoard() { openConfirm("Reset", "Return all images to the Dock?", () => { currentListData.tiers.forEach(t => { currentListData.dock.push(...t.items); t.items = []; }); commitChange(); }); }
        function openCaptionModal() { if (selectedImgObj) { document.getElementById('caption-input').value = selectedImgObj.data.caption || ''; document.getElementById('caption-modal-overlay').style.display='flex'; document.getElementById('caption-input').focus(); } }
        function saveCaption() { selectedImgObj.data.caption = document.getElementById('caption-input').value; closeModal('caption-modal-overlay'); commitChange(); }
        function deleteSelected() { let oldArray = (selectedImgObj.type === 'tier') ? currentListData.tiers[selectedImgObj.r].items : currentListData.dock; oldArray.splice(selectedImgObj.i, 1); commitChange(); deselectImg(); }
        function moveToDock() { let oldArray = (selectedImgObj.type === 'tier') ? currentListData.tiers[selectedImgObj.r].items : currentListData.dock; oldArray.splice(selectedImgObj.i, 1); currentListData.dock.push(selectedImgObj.data); commitChange(); deselectImg(); }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function debounceSaveName() { clearTimeout(saveTimeout); saveTimeout = setTimeout(() => { currentListData.name = document.getElementById('list-name').value; commitChangeSilent(); document.getElementById('tier-header').innerText = currentListData.name; }, 500); }
        async function backToMenu() { document.getElementById('dock-search').value = ''; deselectImg(); showLoading('Saving board...'); try { if (isDirty) saveListSilent(currentListData); const canvas = await html2canvas(document.getElementById('capture-area'), { scale: 1, backgroundColor: '#000', useCORS: true }); currentListData.thumbnail = canvas.toDataURL('image/jpeg', 0.6); saveListSilent(currentListData); } catch (err) {} finally { currentListData = null; selectedImgObj = null; } hideLoading(); document.getElementById('editor-screen').classList.add('hidden'); document.getElementById('menu-screen').classList.remove('hidden'); loadMenu(); }

        // 8. BACKUP & EXPORT ENGINE (LOCAL ONLY)
        function openBackupMenu() { document.getElementById('backup-modal-overlay').style.display='flex'; }
        function exportData() { try { db.transaction(['lists']).objectStore('lists').getAll().onsuccess = e => { const data = JSON.stringify(e.target.result); const blob = new Blob([data], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `TierMaker_Backup_${Date.now()}.json`; a.click(); setTimeout(() => URL.revokeObjectURL(url), 1000); }; } catch (err) { alert("Error exporting data!"); } }
        
        function importData(e) { 
            const file = e.target.files[0]; 
            if (!file) return; 
            const reader = new FileReader(); 
            reader.onload = ev => { 
                try { 
                    const data = JSON.parse(ev.target.result); 
                    if (!isValidTierData(data)) throw new Error("Invalid JSON structure"); 
                    const tx = db.transaction(['lists'], 'readwrite'); 
                    const store = tx.objectStore('lists'); 
                    data.forEach(item => store.put(item)); 
                    tx.oncomplete = () => { alert('‚úÖ Restored successfully!'); loadMenu(); closeModal('backup-modal-overlay'); }; 
                } catch(err) { alert('‚ùå File format error!'); } 
            }; 
            reader.readAsText(file); e.target.value = ''; 
        }
        
        async function copyDataToClipboard() { try { db.transaction(['lists']).objectStore('lists').getAll().onsuccess = async e => { try { await navigator.clipboard.writeText(JSON.stringify(e.target.result)); alert('‚úÖ Data code copied!'); } catch (err) { alert('‚ùå Your device doesn\'t support copying large codes. Please use Download file.'); } }; } catch (err) {} }
        async function pasteDataFromClipboard() { try { const text = await navigator.clipboard.readText(); if (!text) { alert('‚ö†Ô∏è Clipboard is empty!'); return; } processPastedString(text); } catch (err) { document.getElementById('manual-paste-textarea').value = ''; document.getElementById('manual-paste-modal').style.display = 'flex'; document.getElementById('manual-paste-textarea').focus(); } }
        function processManualPaste() { const text = document.getElementById('manual-paste-textarea').value; if (!text) return; closeModal('manual-paste-modal'); processPastedString(text); }
        
        function processPastedString(text) { 
            try { 
                const data = JSON.parse(text); 
                if (!isValidTierData(data)) throw new Error("Invalid data structure"); 
                const tx = db.transaction(['lists'], 'readwrite'); 
                const store = tx.objectStore('lists'); 
                data.forEach(item => store.put(item)); 
                tx.oncomplete = () => { alert('‚úÖ Restored successfully!'); loadMenu(); closeModal('backup-modal-overlay'); }; 
            } catch(e) { alert('‚ùå Invalid code!'); } 
        }

        function wipeAllData() { openConfirm("WARNING", "Wipe ALL data? This action CANNOT be undone!", () => { try { db.transaction(['lists'], 'readwrite').objectStore('lists').clear().onsuccess = () => location.reload(); } catch(e) {} }); }
    </script>
</body>
</html>
